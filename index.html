<!DOCTYPE html><html><head><title>Twilio Chat</title><style>body, html {
  height:100%;
  width:100%;
  padding:0;
  margin:0;
  overflow:hidden;
  background-color:#ddd;
}
.wrapper {
  height:100%;
  width:100%;
}</style><link rel="shortcut icon" href="//twilio.com/bundles/marketing/img/favicons/favicon.ico"><link rel="apple-touch-icon" href="//twilio.com/bundles/marketing/img/favicons/favicon_57.png"><link rel="apple-touch-icon" sizes="72x72" href="//twilio.com/bundles/marketing/img/favicons/favicon_72.png"><link rel="apple-touch-icon" sizes="114x114" href="//twilio.com/bundles/marketing/img/favicons/favicon_114.png"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css"><link rel="stylesheet" href="viewsaurus.css"></head><body><div class="wrapper"><div id="viewsaurus" data-title="Twilio Chat"><div class="saurus-panes"><div class="saurus-prose"><div class="saurus-prose-header"><div class="title-outer"><span class="step-title">Twilio Chat</span></div></div><div class="saurus-nav-buttons"><div class="saurus-nav-button nav-overview"><div class="saurus-nav-button-inner"><i class="fa fa-fw fa-list"></i></div><div class="nav-divider"></div></div><div class="saurus-nav-button nav-previous"><div class="saurus-nav-button-inner"><a href=""> <i class="fa fa-fw fa-play fa-rotate-180"></i></a></div><div class="nav-divider"></div></div><div class="saurus-nav-button nav-next clickable"><div class="saurus-nav-button-inner"><a href="#1"> <i class="fa fa-fw fa-play"></i></a></div></div><div class="saurus-next-title"><span class="next-title-inner"></span></div></div><div class="saurus-progress-bar"></div><div class="saurus-start"><p>Learn to implement a simple chat application using Twilio IP Messaging Client</p><a href="#0">Start Tutorial</a></div><div class="saurus-content"><div data-title="Twilio Chat Swift" class="chapter"><div data-title="Introduction" data-file="app/src/main/AndroidManifest.xml" class="step"><h2 id="introduction">Introduction</h2>
<p>Ready to implement a chat application using Twilio IP Messaging Client?
Here is how it works at a high level:</p>
<ol>
<li><p><a href="//www.twilio.com/ip-messaging">Twilio IP Messaging</a> is the core product
we&#39;ll be using to handle all the chat functionality.</p>
</li>
<li><p>We use a server side app to generate <a href="//www.twilio.com/docs/api/ip-messaging/guides/identity">user access
tokens</a> which contains
all your Twilio account information. The IP Messaging Client uses this token
to connect with the API</p>
</li>
<li><p><a href="//media.twiliocdn.com/sdk/rtc/android/common/releases/0.1.10.b62-b0c2c3f/docs">Twilio Common</a>
is the part of the SDK than handles access tokens and even refreshes them upon token
expiration.</p>
</li>
</ol>
<hr>
<p><strong>See Also:</strong></p>
<ul>
<li><a href="//www.twilio.com/docs/api/ip-messaging">IP Messaging API</a></li>
<li><a href="//www.twilio.com/docs/api/ip-messaging/guides/channels">Channels and Messages</a></li>
<li><a href="//www.twilio.com/docs/api/ip-messaging/guides/channels">User Identity &amp; Access Tokens</a></li>
<li><a href="//media.twiliocdn.com/sdk/rtc/android/ip-messaging/releases/0.4.10.b204-57cc05a/docs">Twilio IP Messaging Client Reference</a></li>
<li><a href="//media.twiliocdn.com/sdk/rtc/android/common/releases/0.1.10.b62-b0c2c3f/docs">Twilio Common Reference</a></li>
</ul>
</div><div data-title="Initializing the Client" data-file="app/src/main/java/com/twilio/twiliochat/ipmessaging/IPMessagingClientManager.java" data-highlight="106-141" class="step"><h2 id="initializing-the-ip-messaging-client">Initializing the IP Messaging Client</h2>
<p>The only thing you need to create a client is an access token. This token
holds information about your Twilio account and IP Messaging API keys. We have created a web
version of Twilio chat in different languages. You can use any of these to generate the token:</p>
<ul>
<li><a href="//github.com/TwilioDevEd/twiliochat-laravel">PHP - Laravel</a></li>
<li><a href="//github.com/TwilioDevEd/twiliochat-csharp">C# - .NET MVC</a></li>
<li><a href="//github.com/TwilioDevEd/twiliochat-servlets">Java - Servlets</a></li>
<li><a href="//github.com/TwilioDevEd/twiliochat-node">JS - Node</a></li>
</ul>
<p>We use <a href="//developer.android.com/training/volley/index.html">Volley</a>
to make a request to our server and get the access token.</p>
<hr>
<p><strong>See Also:</strong></p>
<ul>
<li><a href="//developer.android.com/training/volley/requestqueue.html">Set up a request queue with Volley</a></li>
</ul>
</div><div data-title="Getting the Channel List" data-file="app/src/main/java/com/twilio/twiliochat/ipmessaging/ChannelManager.java" data-highlight="64-98" class="step"><h2 id="getting-the-channel-list">Getting the Channel List</h2>
<p>Our <code>ChannelManager</code> class takes care of everything related to channels.
The first thing we need to do, when the class is initialized, is to store
a list of channels of type <code>Channels</code> that we get by calling the method <code>getChannels</code>
from the IP Messaging Client.</p>
<p>Once we have a <code>Channels</code> object, we can fetch the actual channels using the
<code>Channels&#39;</code> method <code>loadChannelsWithListener</code>. Once that operation
finishes successfully, in order to get an array of channels, call the
method <code>getChannels</code> on the same object.</p>
</div><div data-title="Listen to Client Events" data-file="app/src/main/java/com/twilio/twiliochat/activities/MainChatActivity.java" data-highlight="452-467" class="step"><h2 id="listen-to-client-events">Listen to Client Events</h2>
<p>The IP Messaging Client will trigger events such as <code>onChannelAdd</code> or <code>onChannelDelete</code>
on our application. Given the creation or deletion of a channel we&#39;ll reload the
channel list in the sliding panel. If a channel is deleted and we were currently joined to that
channel, the application will automatically join the general channel.</p>
<p>You must set your <code>IPMessagingClient</code> to listen to events using a
<a href="https://media.twiliocdn.com/sdk/rtc/android/ip-messaging/releases/0.4.10.b204-57cc05a/docs/com/twilio/ipmessaging/IPMessagingClientListener.html">IPMessagingClientListener</a>.
In this particular case, <code>MainChatActivity</code> implements IPMessagingClientListener, but it&#39;s methods
are called from the ChannelManager class that also implements IPMessagingClientListener (who actually is the
client&#39;s listener).
Channel manager is used as an event handler proxy.
Twilio chat sets the listener when loading the channels.</p>
<hr>
<p><strong>See Also:</strong></p>
<ul>
<li><a href="//media.twiliocdn.com/sdk/rtc/android/ip-messaging/releases/0.4.10.b204-57cc05a/docs/com/twilio/ipmessaging/IPMessagingClientListener.html">IPMessagingClientListener available event</a></li>
<li><a href="//github.com/TwilioDevEd/twiliochat-android/blob/1bcde08d53ad6ddc3a738ed254346e269e655922/app/src/main/java/com/twilio/twiliochat/ipmessaging/ChannelManager.java#L177-L217">ChannelManager as an event proxy</a></li>
</ul>
</div><div data-title="Join the General Channel" data-file="app/src/main/java/com/twilio/twiliochat/ipmessaging/ChannelManager.java" data-highlight="117-166" class="step"><h2 id="join-the-general-channel">Join the General Channel</h2>
<p>This application will try to join a channel called &quot;General Channel&quot; when it starts.
If the channel doesn&#39;t exist it&#39;ll create one with that name. The scope of
this example application will show you how to work only with public channels
but the IP Messaging client allows you to create private channels and handle
invitations.</p>
<p>Notice we set a unique name for the general channel as we don&#39;t want to
create a new general channel every time we start the application.</p>
</div><div data-title="Listen to Channel Events" data-file="app/src/main/java/com/twilio/twiliochat/fragments/MainChatFragment.java" data-highlight="166-181" class="step"><h2 id="listen-to-channel-events">Listen to Channel Events</h2>
<p>We set a channel&#39;s listener to <code>MainChatFragment</code> that implements <code>ChannelListener</code>,
and here we implemented the following methods that listen to channel events:</p>
<ul>
<li><code>messageAdded</code>: When someone sends a message to the channel you are connected to.</li>
<li><code>memberJoined</code>: When someone joins the channel.</li>
<li><code>memberLeft</code>: When someone leaves the channel.</li>
</ul>
<p>As you may have noticed, each one of these methods include useful objects
as parameters. One example is the actual message that was added to the channel.</p>
</div><div data-title="Joining Other Channels" data-file="app/src/main/java/com/twilio/twiliochat/fragments/MainChatFragment.java" data-highlight="109-146" class="step"><h2 id="joining-other-channels">Joining Other Channels</h2>
<p>The application uses a <a href="//developer.android.com/reference/android/support/v4/widget/DrawerLayout.html">Drawer Layout</a>
to show a list of the channels created for that Twilio account.</p>
<p>When you tap on the name of a channel, from the sidebar, that channel is set
on the <code>MainChatFragment</code>. The <code>setCurrentChannel</code> method takes care of joining
to the selected channel and loading the messages.</p>
</div><div data-title="Creating a Channel" data-file="app/src/main/java/com/twilio/twiliochat/ipmessaging/ChannelManager.java" data-highlight="100-115" class="step"><h2 id="creating-a-channel">Creating a Channel</h2>
<p>We use an input dialog so the user can type the name of the new channel.
The only restriction here is that the user can&#39;t create a channel called
&quot;General Channel&quot;. Other than that, creating a channel is as simple as calling
<code>createChannel(Map&lt;String, Object&gt; options, CreateChannelListener listener)</code>
where <code>options</code> has the following required keys:</p>
<ul>
<li>Constants.CHANNEL_FRIENDLY_NAME</li>
<li>Constants.CHANNEL_TYPE</li>
</ul>
<p>You can use additional keys to create a channel with more details as we did
with general channel to set a unique name. There&#39;s a list of keys you can use
<a href="//media.twiliocdn.com/sdk/rtc/android/ip-messaging/releases/0.4.10.b204-57cc05a/docs/com/twilio/ipmessaging/Constants.html">here</a>.</p>
</div><div data-title="Deleting a Channel" data-file="app/src/main/java/com/twilio/twiliochat/ipmessaging/ChannelManager.java" data-highlight="60-62" class="step"><h2 id="deleting-a-channel">Deleting a Channel</h2>
<p>Deleting a channel is easier than creating one. The application
lets the user delete the channel they are currently joined to through a menu
option. In order to delete the channel from Twilio you have to call
the <code>destroy</code> method on the channel you are trying to delete. But you still
need to provide a <code>StatusListener</code> to handle the success or failure of the operation.</p>
</div><div data-title="Where to Next?" class="step"><h2 id="where-to-next-">Where to Next?</h2>
<p>That&#39;s it! We&#39;ve just implemented a simple chat application for Android.</p>
<p>Thanks for checking out this tutorial! If you have any feedback to share
with us, we&#39;d love to hear it. Tweet
<a href="http://twitter.com/twilio">@twilio</a> to let us know what you think.</p>
</div></div>
<div class="saurus-files" style="display:none;"><textarea class="saurus-file" data-file="app/src/main/AndroidManifest.xml" data-mode="xml">PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPG1hbmlmZXN0CiAgICBwYWNrYWdlPSJjb20udHdpbGlvLnR3aWxpb2NoYXQiCiAgICB4bWxuczphbmRyb2lkPSJodHRwOi8vc2NoZW1hcy5hbmRyb2lkLmNvbS9hcGsvcmVzL2FuZHJvaWQiPgoKICAgIDx1c2VzLXBlcm1pc3Npb24gYW5kcm9pZDpuYW1lPSJhbmRyb2lkLnBlcm1pc3Npb24uSU5URVJORVQiLz4KICAgIDx1c2VzLXBlcm1pc3Npb24gYW5kcm9pZDpuYW1lPSJhbmRyb2lkLnBlcm1pc3Npb24uQUNDRVNTX05FVFdPUktfU1RBVEUiLz4KICAgIDx1c2VzLXBlcm1pc3Npb24gYW5kcm9pZDpuYW1lPSJhbmRyb2lkLnBlcm1pc3Npb24uQUNDRVNTX1dJRklfU1RBVEUiLz4KICAgIDx1c2VzLXBlcm1pc3Npb24gYW5kcm9pZDpuYW1lPSJhbmRyb2lkLnBlcm1pc3Npb24uV0FLRV9MT0NLIi8+CgogICAgPGFwcGxpY2F0aW9uCiAgICAgICAgYW5kcm9pZDpuYW1lPSIuYXBwbGljYXRpb24uVHdpbGlvQ2hhdEFwcGxpY2F0aW9uIgogICAgICAgIGFuZHJvaWQ6YWxsb3dCYWNrdXA9InRydWUiCiAgICAgICAgYW5kcm9pZDppY29uPSJAbWlwbWFwL2ljX2xhdW5jaGVyIgogICAgICAgIGFuZHJvaWQ6bGFiZWw9IkBzdHJpbmcvYXBwX25hbWUiCiAgICAgICAgYW5kcm9pZDpzdXBwb3J0c1J0bD0idHJ1ZSIKICAgICAgICBhbmRyb2lkOnRoZW1lPSJAc3R5bGUvQXBwVGhlbWUiPgoKICAgICAgICA8YWN0aXZpdHkKICAgICAgICAgICAgYW5kcm9pZDpuYW1lPSIuYWN0aXZpdGllcy5MYXVuY2hBY3Rpdml0eSIKICAgICAgICAgICAgYW5kcm9pZDpsYWJlbD0iQHN0cmluZy9hcHBfbmFtZSI+CiAgICAgICAgICAgIDxpbnRlbnQtZmlsdGVyPgogICAgICAgICAgICAgICAgPGFjdGlvbiBhbmRyb2lkOm5hbWU9ImFuZHJvaWQuaW50ZW50LmFjdGlvbi5NQUlOIi8+CgogICAgICAgICAgICAgICAgPGNhdGVnb3J5IGFuZHJvaWQ6bmFtZT0iYW5kcm9pZC5pbnRlbnQuY2F0ZWdvcnkuTEFVTkNIRVIiLz4KICAgICAgICAgICAgPC9pbnRlbnQtZmlsdGVyPgogICAgICAgIDwvYWN0aXZpdHk+CiAgICAgICAgPGFjdGl2aXR5CiAgICAgICAgICAgIGFuZHJvaWQ6bmFtZT0iLmFjdGl2aXRpZXMuTG9naW5BY3Rpdml0eSIKICAgICAgICAgICAgYW5kcm9pZDpzY3JlZW5PcmllbnRhdGlvbj0icG9ydHJhaXQiLz4KICAgICAgICA8YWN0aXZpdHkKICAgICAgICAgICAgYW5kcm9pZDpuYW1lPSIuYWN0aXZpdGllcy5NYWluQ2hhdEFjdGl2aXR5IgogICAgICAgICAgICBhbmRyb2lkOmNvbmZpZ0NoYW5nZXM9Im9yaWVudGF0aW9ufHNjcmVlblNpemUiCiAgICAgICAgICAgIGFuZHJvaWQ6bGFiZWw9IkBzdHJpbmcvdGl0bGVfYWN0aXZpdHlfbWFpbl9jaGF0IgogICAgICAgICAgICBhbmRyb2lkOnRoZW1lPSJAc3R5bGUvQXBwVGhlbWUuTm9BY3Rpb25CYXIiLz4KCiAgICAgICAgPHNlcnZpY2UKICAgICAgICAgICAgYW5kcm9pZDpuYW1lPSJjb20udHdpbGlvLmlwbWVzc2FnaW5nLlR3aWxpb0lQTWVzc2FnaW5nQ2xpZW50U2VydmljZSIKICAgICAgICAgICAgYW5kcm9pZDpleHBvcnRlZD0iZmFsc2UiLz4KICAgIDwvYXBwbGljYXRpb24+Cgo8L21hbmlmZXN0Pgo=</textarea>
<textarea class="saurus-file" data-file="app/src/main/java/com/twilio/twiliochat/ipmessaging/IPMessagingClientManager.java" data-mode="java">cGFja2FnZSBjb20udHdpbGlvLnR3aWxpb2NoYXQuaXBtZXNzYWdpbmc7CgppbXBvcnQgamF2YS51dGlsLkhhc2hNYXA7CmltcG9ydCBqYXZhLnV0aWwuTWFwOwoKaW1wb3J0IG9yZy5qc29uLkpTT05FeGNlcHRpb247CmltcG9ydCBvcmcuanNvbi5KU09OT2JqZWN0OwoKaW1wb3J0IGFuZHJvaWQuY29udGVudC5Db250ZXh0OwppbXBvcnQgYW5kcm9pZC5jb250ZW50LnJlcy5SZXNvdXJjZXM7CmltcG9ydCBhbmRyb2lkLm9zLkhhbmRsZXI7CmltcG9ydCBhbmRyb2lkLnByb3ZpZGVyLlNldHRpbmdzOwoKaW1wb3J0IGNvbS5hbmRyb2lkLnZvbGxleS5SZXF1ZXN0Lk1ldGhvZDsKaW1wb3J0IGNvbS5hbmRyb2lkLnZvbGxleS5SZXNwb25zZTsKaW1wb3J0IGNvbS5hbmRyb2lkLnZvbGxleS5Wb2xsZXlFcnJvcjsKaW1wb3J0IGNvbS5hbmRyb2lkLnZvbGxleS50b29sYm94Lkpzb25PYmplY3RSZXF1ZXN0OwppbXBvcnQgY29tLnR3aWxpby5jb21tb24uVHdpbGlvQWNjZXNzTWFuYWdlcjsKaW1wb3J0IGNvbS50d2lsaW8uY29tbW9uLlR3aWxpb0FjY2Vzc01hbmFnZXJGYWN0b3J5OwppbXBvcnQgY29tLnR3aWxpby5jb21tb24uVHdpbGlvQWNjZXNzTWFuYWdlckxpc3RlbmVyOwppbXBvcnQgY29tLnR3aWxpby5pcG1lc3NhZ2luZy5DaGFubmVsOwppbXBvcnQgY29tLnR3aWxpby5pcG1lc3NhZ2luZy5Db25zdGFudHM7CmltcG9ydCBjb20udHdpbGlvLmlwbWVzc2FnaW5nLklQTWVzc2FnaW5nQ2xpZW50TGlzdGVuZXI7CmltcG9ydCBjb20udHdpbGlvLmlwbWVzc2FnaW5nLlR3aWxpb0lQTWVzc2FnaW5nQ2xpZW50OwppbXBvcnQgY29tLnR3aWxpby5pcG1lc3NhZ2luZy5Ud2lsaW9JUE1lc3NhZ2luZ1NESzsKaW1wb3J0IGNvbS50d2lsaW8udHdpbGlvY2hhdC5SOwppbXBvcnQgY29tLnR3aWxpby50d2lsaW9jaGF0LmFwcGxpY2F0aW9uLlR3aWxpb0NoYXRBcHBsaWNhdGlvbjsKaW1wb3J0IGNvbS50d2lsaW8udHdpbGlvY2hhdC5pbnRlcmZhY2VzLkZldGNoVG9rZW5MaXN0ZW5lcjsKaW1wb3J0IGNvbS50d2lsaW8udHdpbGlvY2hhdC5pbnRlcmZhY2VzLkxvZ2luTGlzdGVuZXI7CmltcG9ydCBjb20udHdpbGlvLnR3aWxpb2NoYXQudXRpbC5TZXNzaW9uTWFuYWdlcjsKCnB1YmxpYyBjbGFzcyBJUE1lc3NhZ2luZ0NsaWVudE1hbmFnZXIgaW1wbGVtZW50cyBJUE1lc3NhZ2luZ0NsaWVudExpc3RlbmVyIHsKICBwcml2YXRlIGZpbmFsIFN0cmluZyBUT0tFTl9LRVkgPSAidG9rZW4iOwogIHByaXZhdGUgZmluYWwgSGFuZGxlciBoYW5kbGVyID0gbmV3IEhhbmRsZXIoKTsKICBwcml2YXRlIFN0cmluZyBjYXBhYmlsaXR5VG9rZW47CiAgcHJpdmF0ZSBUd2lsaW9JUE1lc3NhZ2luZ0NsaWVudCBpcE1lc3NhZ2luZ0NsaWVudDsKICBwcml2YXRlIENvbnRleHQgY29udGV4dDsKICBwcml2YXRlIFR3aWxpb0FjY2Vzc01hbmFnZXIgYWNjZXNzTWFuYWdlcjsKCiAgcHVibGljIElQTWVzc2FnaW5nQ2xpZW50TWFuYWdlcihDb250ZXh0IGNvbnRleHQpIHsKICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgfQoKICBwdWJsaWMgSVBNZXNzYWdpbmdDbGllbnRNYW5hZ2VyKCkge30KCiAgcHVibGljIFN0cmluZyBnZXRDYXBhYmlsaXR5VG9rZW4oKSB7CiAgICByZXR1cm4gY2FwYWJpbGl0eVRva2VuOwogIH0KCiAgcHVibGljIHZvaWQgc2V0Q2FwYWJpbGl0eVRva2VuKFN0cmluZyBjYXBhYmlsaXR5VG9rZW4pIHsKICAgIHRoaXMuY2FwYWJpbGl0eVRva2VuID0gY2FwYWJpbGl0eVRva2VuOwogICAgaWYgKHRoaXMuYWNjZXNzTWFuYWdlciAhPSBudWxsKSB7CiAgICAgIHRoaXMuYWNjZXNzTWFuYWdlci51cGRhdGVUb2tlbihjYXBhYmlsaXR5VG9rZW4pOwogICAgfQogIH0KCiAgcHVibGljIHZvaWQgc2V0Q2xpZW50TGlzdGVuZXIoSVBNZXNzYWdpbmdDbGllbnRMaXN0ZW5lciBsaXN0ZW5lcikgewogICAgaWYgKHRoaXMuaXBNZXNzYWdpbmdDbGllbnQgIT0gbnVsbCkgewogICAgICB0aGlzLmlwTWVzc2FnaW5nQ2xpZW50LnNldExpc3RlbmVyKGxpc3RlbmVyKTsKICAgIH0KICB9CgogIHB1YmxpYyBUd2lsaW9JUE1lc3NhZ2luZ0NsaWVudCBnZXRJcE1lc3NhZ2luZ0NsaWVudCgpIHsKICAgIHJldHVybiB0aGlzLmlwTWVzc2FnaW5nQ2xpZW50OwogIH0KCiAgcHVibGljIHZvaWQgc2V0SXBNZXNzYWdpbmdDbGllbnQoVHdpbGlvSVBNZXNzYWdpbmdDbGllbnQgY2xpZW50KSB7CiAgICB0aGlzLmlwTWVzc2FnaW5nQ2xpZW50ID0gY2xpZW50OwogIH0KCiAgcHVibGljIHZvaWQgY29ubmVjdENsaWVudChmaW5hbCBMb2dpbkxpc3RlbmVyIGxpc3RlbmVyKSB7CiAgICBUd2lsaW9JUE1lc3NhZ2luZ1NESy5zZXRMb2dMZXZlbChhbmRyb2lkLnV0aWwuTG9nLkRFQlVHKTsKICAgIGlmICghVHdpbGlvSVBNZXNzYWdpbmdTREsuaXNJbml0aWFsaXplZCgpKSB7CiAgICAgIFR3aWxpb0lQTWVzc2FnaW5nU0RLLmluaXRpYWxpemVTREsoY29udGV4dCwgbmV3IENvbnN0YW50cy5Jbml0TGlzdGVuZXIoKSB7CiAgICAgICAgQE92ZXJyaWRlCiAgICAgICAgcHVibGljIHZvaWQgb25Jbml0aWFsaXplZCgpIHsKICAgICAgICAgIGNyZWF0ZUNsaWVudFdpdGhBY2Nlc3NNYW5hZ2VyKGxpc3RlbmVyKTsKICAgICAgICB9CgogICAgICAgIEBPdmVycmlkZQogICAgICAgIHB1YmxpYyB2b2lkIG9uRXJyb3IoRXhjZXB0aW9uIGVycm9yKSB7CiAgICAgICAgICBTeXN0ZW0ub3V0LnByaW50bG4oIkVycm9yIGluaXRpYWxpemluZyB0aGUgU0RLIDoiICsgZXJyb3IuZ2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgY3JlYXRlQ2xpZW50V2l0aEFjY2Vzc01hbmFnZXIobGlzdGVuZXIpOwogICAgfQogIH0KCiAgcHJpdmF0ZSB2b2lkIGNyZWF0ZUNsaWVudFdpdGhBY2Nlc3NNYW5hZ2VyKGZpbmFsIExvZ2luTGlzdGVuZXIgbGlzdGVuZXIpIHsKICAgIGZldGNoQWNjZXNzVG9rZW4obmV3IEZldGNoVG9rZW5MaXN0ZW5lcigpIHsKICAgICAgQE92ZXJyaWRlCiAgICAgIHB1YmxpYyB2b2lkIGZldGNoVG9rZW5TdWNjZXNzKFN0cmluZyB0b2tlbikgewogICAgICAgIGluaXRpYWxpemVDbGllbnRXaXRoVG9rZW4odG9rZW4sIGxpc3RlbmVyKTsKICAgICAgfQoKICAgICAgQE92ZXJyaWRlCiAgICAgIHB1YmxpYyB2b2lkIGZldGNoVG9rZW5GYWlsdXJlKEV4Y2VwdGlvbiBlKSB7CiAgICAgICAgaWYgKGxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgIGxpc3RlbmVyLm9uTG9naW5FcnJvcihlLmdldExvY2FsaXplZE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CgogIHByaXZhdGUgdm9pZCBpbml0aWFsaXplQ2xpZW50V2l0aFRva2VuKFN0cmluZyB0b2tlbiwgZmluYWwgTG9naW5MaXN0ZW5lciBsaXN0ZW5lcikgewogICAgdGhpcy5hY2Nlc3NNYW5hZ2VyID0KICAgICAgICBUd2lsaW9BY2Nlc3NNYW5hZ2VyRmFjdG9yeS5jcmVhdGVBY2Nlc3NNYW5hZ2VyKHRva2VuLCBuZXcgVHdpbGlvQWNjZXNzTWFuYWdlckxpc3RlbmVyKCkgewogICAgICAgICAgQE92ZXJyaWRlCiAgICAgICAgICBwdWJsaWMgdm9pZCBvbkFjY2Vzc01hbmFnZXJUb2tlbkV4cGlyZShUd2lsaW9BY2Nlc3NNYW5hZ2VyIHR3aWxpb0FjY2Vzc01hbmFnZXIpIHsKICAgICAgICAgICAgU3lzdGVtLm91dC5wcmludGxuKCJ0b2tlbiBleHBpcmVkLiIpOwogICAgICAgICAgICBmZXRjaEFjY2Vzc1Rva2VuKG5ldyBGZXRjaFRva2VuTGlzdGVuZXIoKSB7CiAgICAgICAgICAgICAgQE92ZXJyaWRlCiAgICAgICAgICAgICAgcHVibGljIHZvaWQgZmV0Y2hUb2tlblN1Y2Nlc3MoU3RyaW5nIHRva2VuKSB7CiAgICAgICAgICAgICAgICBJUE1lc3NhZ2luZ0NsaWVudE1hbmFnZXIudGhpcy5hY2Nlc3NNYW5hZ2VyLnVwZGF0ZVRva2VuKHRva2VuKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgICAgIHB1YmxpYyB2b2lkIGZldGNoVG9rZW5GYWlsdXJlKEV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgICAgICBTeXN0ZW0ub3V0LnByaW50bG4oIkVycm9yIHRyeWluZyB0byBmZXRjaCB0b2tlbjogIiArIGUuZ2V0TG9jYWxpemVkTWVzc2FnZSgpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgcHVibGljIHZvaWQgb25Ub2tlblVwZGF0ZWQoVHdpbGlvQWNjZXNzTWFuYWdlciB0d2lsaW9BY2Nlc3NNYW5hZ2VyKSB7CiAgICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRsbigidG9rZW4gdXBkYXRlZC4iKTsKICAgICAgICAgIH0KCiAgICAgICAgICBAT3ZlcnJpZGUKICAgICAgICAgIHB1YmxpYyB2b2lkIG9uRXJyb3IoVHdpbGlvQWNjZXNzTWFuYWdlciB0d2lsaW9BY2Nlc3NNYW5hZ2VyLCBTdHJpbmcgcykgewogICAgICAgICAgICBTeXN0ZW0ub3V0LnByaW50bG4oInRva2VuIGVycm9yOiAiICsgcyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgaXBNZXNzYWdpbmdDbGllbnQgPQogICAgICAgIFR3aWxpb0lQTWVzc2FnaW5nU0RLLmNyZWF0ZUlQTWVzc2FnaW5nQ2xpZW50V2l0aEFjY2Vzc01hbmFnZXIodGhpcy5hY2Nlc3NNYW5hZ2VyLCB0aGlzKTsKICAgIGlmIChsaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgIGxpc3RlbmVyLm9uTG9naW5GaW5pc2hlZCgpOwogICAgfQogIH0KCiAgcHJpdmF0ZSB2b2lkIGZldGNoQWNjZXNzVG9rZW4oZmluYWwgRmV0Y2hUb2tlbkxpc3RlbmVyIGxpc3RlbmVyKSB7CiAgICBKU09OT2JqZWN0IG9iaiA9IG5ldyBKU09OT2JqZWN0KGdldFRva2VuUmVxdWVzdFBhcmFtcygpKTsKICAgIFN0cmluZyByZXF1ZXN0VXJsID0gZ2V0U3RyaW5nUmVzb3VyY2UoUi5zdHJpbmcudG9rZW5fdXJsKTsKICAgIEpzb25PYmplY3RSZXF1ZXN0IGpzb25PYmpSZXEgPQogICAgICAgIG5ldyBKc29uT2JqZWN0UmVxdWVzdChNZXRob2QuUE9TVCwgcmVxdWVzdFVybCwgb2JqLCBuZXcgUmVzcG9uc2UuTGlzdGVuZXI8SlNPTk9iamVjdD4oKSB7CgogICAgICAgICAgQE92ZXJyaWRlCiAgICAgICAgICBwdWJsaWMgdm9pZCBvblJlc3BvbnNlKEpTT05PYmplY3QgcmVzcG9uc2UpIHsKICAgICAgICAgICAgU3RyaW5nIHRva2VuID0gbnVsbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB0b2tlbiA9IHJlc3BvbnNlLmdldFN0cmluZygidG9rZW4iKTsKICAgICAgICAgICAgfSBjYXRjaCAoSlNPTkV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgICAgZS5wcmludFN0YWNrVHJhY2UoKTsKICAgICAgICAgICAgICBsaXN0ZW5lci5mZXRjaFRva2VuRmFpbHVyZShuZXcgRXhjZXB0aW9uKCJGYWlsZWQgdG8gcGFyc2UgdG9rZW4gSlNPTiByZXNwb25zZSIpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsaXN0ZW5lci5mZXRjaFRva2VuU3VjY2Vzcyh0b2tlbik7CiAgICAgICAgICB9CiAgICAgICAgfSwgbmV3IFJlc3BvbnNlLkVycm9yTGlzdGVuZXIoKSB7CgogICAgICAgICAgQE92ZXJyaWRlCiAgICAgICAgICBwdWJsaWMgdm9pZCBvbkVycm9yUmVzcG9uc2UoVm9sbGV5RXJyb3IgZXJyb3IpIHsKICAgICAgICAgICAgbGlzdGVuZXIuZmV0Y2hUb2tlbkZhaWx1cmUobmV3IEV4Y2VwdGlvbigiRmFpbGVkIHRvIGZldGNoIHRva2VuIikpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAganNvbk9ialJlcS5zZXRTaG91bGRDYWNoZShmYWxzZSk7CiAgICBUb2tlblJlcXVlc3QuZ2V0SW5zdGFuY2UoKS5hZGRUb1JlcXVlc3RRdWV1ZShqc29uT2JqUmVxKTsKICB9CgogIHByaXZhdGUgU3RyaW5nIGdldFN0cmluZ1Jlc291cmNlKGludCBpZCkgewogICAgUmVzb3VyY2VzIHJlc291cmNlcyA9IFR3aWxpb0NoYXRBcHBsaWNhdGlvbi5nZXQoKS5nZXRSZXNvdXJjZXMoKTsKICAgIHJldHVybiByZXNvdXJjZXMuZ2V0U3RyaW5nKGlkKTsKICB9CgogIHByaXZhdGUgTWFwPFN0cmluZywgU3RyaW5nPiBnZXRUb2tlblJlcXVlc3RQYXJhbXMoKSB7CiAgICBTdHJpbmcgYW5kcm9pZElkID0KICAgICAgICBTZXR0aW5ncy5TZWN1cmUuZ2V0U3RyaW5nKGNvbnRleHQuZ2V0Q29udGVudFJlc29sdmVyKCksIFNldHRpbmdzLlNlY3VyZS5BTkRST0lEX0lEKTsKICAgIE1hcDxTdHJpbmcsIFN0cmluZz4gcGFyYW1zID0gbmV3IEhhc2hNYXA8PigpOwogICAgcGFyYW1zLnB1dCgiZGV2aWNlSWQiLCBhbmRyb2lkSWQpOwogICAgcGFyYW1zLnB1dCgiaWRlbnRpdHkiLCBTZXNzaW9uTWFuYWdlci5nZXRJbnN0YW5jZSgpLmdldFVzZXJuYW1lKCkpOwogICAgcmV0dXJuIHBhcmFtczsKICB9CgogIEBPdmVycmlkZQogIHB1YmxpYyB2b2lkIG9uQ2hhbm5lbEFkZChDaGFubmVsIGNoYW5uZWwpIHt9CgogIEBPdmVycmlkZQogIHB1YmxpYyB2b2lkIG9uQ2hhbm5lbENoYW5nZShDaGFubmVsIGNoYW5uZWwpIHt9CgogIEBPdmVycmlkZQogIHB1YmxpYyB2b2lkIG9uQ2hhbm5lbERlbGV0ZShDaGFubmVsIGNoYW5uZWwpIHt9CgogIEBPdmVycmlkZQogIHB1YmxpYyB2b2lkIG9uRXJyb3IoaW50IGksIFN0cmluZyBzKSB7fQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbkF0dHJpYnV0ZXNDaGFuZ2UoU3RyaW5nIHMpIHt9CgogIEBPdmVycmlkZQogIHB1YmxpYyB2b2lkIG9uQ2hhbm5lbEhpc3RvcnlMb2FkZWQoQ2hhbm5lbCBjaGFubmVsKSB7fQp9Cg==</textarea>
<textarea class="saurus-file" data-file="app/src/main/java/com/twilio/twiliochat/ipmessaging/ChannelManager.java" data-mode="java">cGFja2FnZSBjb20udHdpbGlvLnR3aWxpb2NoYXQuaXBtZXNzYWdpbmc7CgppbXBvcnQgamF2YS51dGlsLkFycmF5TGlzdDsKaW1wb3J0IGphdmEudXRpbC5BcnJheXM7CmltcG9ydCBqYXZhLnV0aWwuQ29sbGVjdGlvbnM7CmltcG9ydCBqYXZhLnV0aWwuSGFzaE1hcDsKaW1wb3J0IGphdmEudXRpbC5MaXN0OwppbXBvcnQgamF2YS51dGlsLk1hcDsKCmltcG9ydCBhbmRyb2lkLmNvbnRlbnQucmVzLlJlc291cmNlczsKaW1wb3J0IGFuZHJvaWQub3MuSGFuZGxlcjsKaW1wb3J0IGFuZHJvaWQub3MuTG9vcGVyOwoKaW1wb3J0IGNvbS50d2lsaW8uaXBtZXNzYWdpbmcuQ2hhbm5lbDsKaW1wb3J0IGNvbS50d2lsaW8uaXBtZXNzYWdpbmcuQ2hhbm5lbC5DaGFubmVsVHlwZTsKaW1wb3J0IGNvbS50d2lsaW8uaXBtZXNzYWdpbmcuQ2hhbm5lbHM7CmltcG9ydCBjb20udHdpbGlvLmlwbWVzc2FnaW5nLkNvbnN0YW50czsKaW1wb3J0IGNvbS50d2lsaW8uaXBtZXNzYWdpbmcuSVBNZXNzYWdpbmdDbGllbnRMaXN0ZW5lcjsKaW1wb3J0IGNvbS50d2lsaW8udHdpbGlvY2hhdC5SOwppbXBvcnQgY29tLnR3aWxpby50d2lsaW9jaGF0LmFwcGxpY2F0aW9uLlR3aWxpb0NoYXRBcHBsaWNhdGlvbjsKaW1wb3J0IGNvbS50d2lsaW8udHdpbGlvY2hhdC5pbnRlcmZhY2VzLkxvYWRDaGFubmVsTGlzdGVuZXI7CgpwdWJsaWMgY2xhc3MgQ2hhbm5lbE1hbmFnZXIgaW1wbGVtZW50cyBJUE1lc3NhZ2luZ0NsaWVudExpc3RlbmVyIHsKICBwcml2YXRlIHN0YXRpYyBDaGFubmVsTWFuYWdlciBzaGFyZWRNYW5hZ2VyID0gbmV3IENoYW5uZWxNYW5hZ2VyKCk7CiAgcHVibGljIENoYW5uZWwgZ2VuZXJhbENoYW5uZWw7CiAgcHJpdmF0ZSBJUE1lc3NhZ2luZ0NsaWVudE1hbmFnZXIgY2xpZW50OwogIHByaXZhdGUgTGlzdDxDaGFubmVsPiBjaGFubmVsczsKICBwcml2YXRlIENoYW5uZWxzIGNoYW5uZWxzT2JqZWN0OwogIHByaXZhdGUgQ2hhbm5lbFtdIGNoYW5uZWxBcnJheTsKICBwcml2YXRlIElQTWVzc2FnaW5nQ2xpZW50TGlzdGVuZXIgbGlzdGVuZXI7CiAgcHJpdmF0ZSBTdHJpbmcgZGVmYXVsdENoYW5uZWxOYW1lOwogIHByaXZhdGUgU3RyaW5nIGRlZmF1bHRDaGFubmVsVW5pcXVlTmFtZTsKICBwcml2YXRlIEhhbmRsZXIgaGFuZGxlcjsKICBwcml2YXRlIEJvb2xlYW4gaXNSZWZyZXNoaW5nQ2hhbm5lbHMgPSBmYWxzZTsKCiAgcHJpdmF0ZSBDaGFubmVsTWFuYWdlcigpIHsKICAgIHRoaXMuY2xpZW50ID0gVHdpbGlvQ2hhdEFwcGxpY2F0aW9uLmdldCgpLmdldElQTWVzc2FnaW5nQ2xpZW50KCk7CiAgICB0aGlzLmxpc3RlbmVyID0gdGhpczsKICAgIGRlZmF1bHRDaGFubmVsTmFtZSA9IGdldFN0cmluZ1Jlc291cmNlKFIuc3RyaW5nLmRlZmF1bHRfY2hhbm5lbF9uYW1lKTsKICAgIGRlZmF1bHRDaGFubmVsVW5pcXVlTmFtZSA9IGdldFN0cmluZ1Jlc291cmNlKFIuc3RyaW5nLmRlZmF1bHRfY2hhbm5lbF91bmlxdWVfbmFtZSk7CiAgICBoYW5kbGVyID0gc2V0dXBMaXN0ZW5lckhhbmRsZXIoKTsKICB9CgogIHB1YmxpYyBzdGF0aWMgQ2hhbm5lbE1hbmFnZXIgZ2V0SW5zdGFuY2UoKSB7CiAgICByZXR1cm4gc2hhcmVkTWFuYWdlcjsKICB9CgogIHB1YmxpYyBMaXN0PENoYW5uZWw+IGdldENoYW5uZWxzKCkgewogICAgcmV0dXJuIGNoYW5uZWxzOwogIH0KCiAgcHVibGljIFN0cmluZyBnZXREZWZhdWx0Q2hhbm5lbE5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy5kZWZhdWx0Q2hhbm5lbE5hbWU7CiAgfQoKICBwdWJsaWMgdm9pZCBsZWF2ZUNoYW5uZWxXaXRoSGFuZGxlcihDaGFubmVsIGNoYW5uZWwsIENvbnN0YW50cy5TdGF0dXNMaXN0ZW5lciBoYW5kbGVyKSB7CiAgICBjaGFubmVsLmxlYXZlKGhhbmRsZXIpOwogIH0KCiAgcHVibGljIHZvaWQgZGVsZXRlQ2hhbm5lbFdpdGhIYW5kbGVyKENoYW5uZWwgY2hhbm5lbCwgQ29uc3RhbnRzLlN0YXR1c0xpc3RlbmVyIGhhbmRsZXIpIHsKICAgIGNoYW5uZWwuZGVzdHJveShoYW5kbGVyKTsKICB9CgogIHB1YmxpYyB2b2lkIHBvcHVsYXRlQ2hhbm5lbHMoZmluYWwgTG9hZENoYW5uZWxMaXN0ZW5lciBsaXN0ZW5lcikgewogICAgaWYgKHRoaXMuY2xpZW50ID09IG51bGwgfHwgdGhpcy5pc1JlZnJlc2hpbmdDaGFubmVscykgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmlzUmVmcmVzaGluZ0NoYW5uZWxzID0gdHJ1ZTsKICAgIGhhbmRsZXIucG9zdChuZXcgUnVubmFibGUoKSB7CiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBydW4oKSB7CiAgICAgICAgY2hhbm5lbHNPYmplY3QgPSBjbGllbnQuZ2V0SXBNZXNzYWdpbmdDbGllbnQoKS5nZXRDaGFubmVscygpOwogICAgICAgIGlmIChjaGFubmVsc09iamVjdCAhPSBudWxsKSB7CiAgICAgICAgICBjaGFubmVsc09iamVjdC5sb2FkQ2hhbm5lbHNXaXRoTGlzdGVuZXIobmV3IENvbnN0YW50cy5TdGF0dXNMaXN0ZW5lcigpIHsKICAgICAgICAgICAgQE92ZXJyaWRlCiAgICAgICAgICAgIHB1YmxpYyB2b2lkIG9uRXJyb3IoKSB7CiAgICAgICAgICAgICAgQ2hhbm5lbE1hbmFnZXIudGhpcy5pc1JlZnJlc2hpbmdDaGFubmVscyA9IGZhbHNlOwogICAgICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRsbigiRmFpbGVkIHRvIGxvYWRDaGFubmVsc1dpdGhMaXN0ZW5lciIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBAT3ZlcnJpZGUKICAgICAgICAgICAgcHVibGljIHZvaWQgb25TdWNjZXNzKCkgewogICAgICAgICAgICAgIGNoYW5uZWxzID0gbmV3IEFycmF5TGlzdDw+KCk7CgogICAgICAgICAgICAgIGNoYW5uZWxBcnJheSA9IGNoYW5uZWxzT2JqZWN0LmdldENoYW5uZWxzKCk7CiAgICAgICAgICAgICAgaWYgKENoYW5uZWxNYW5hZ2VyLnRoaXMuY2hhbm5lbHMgIT0gbnVsbCAmJiBjaGFubmVsQXJyYXkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgQ2hhbm5lbE1hbmFnZXIudGhpcy5jaGFubmVscy5hZGRBbGwoQXJyYXlzLmFzTGlzdChjaGFubmVsQXJyYXkpKTsKICAgICAgICAgICAgICAgIENvbGxlY3Rpb25zLnNvcnQoQ2hhbm5lbE1hbmFnZXIudGhpcy5jaGFubmVscywgbmV3IEN1c3RvbUNoYW5uZWxDb21wYXJhdG9yKCkpOwogICAgICAgICAgICAgICAgQ2hhbm5lbE1hbmFnZXIudGhpcy5pc1JlZnJlc2hpbmdDaGFubmVscyA9IGZhbHNlOwogICAgICAgICAgICAgICAgY2xpZW50LnNldENsaWVudExpc3RlbmVyKENoYW5uZWxNYW5hZ2VyLnRoaXMpOwogICAgICAgICAgICAgICAgbGlzdGVuZXIub25DaGFubmVsc0ZpbmlzaGVkTG9hZGluZyhDaGFubmVsTWFuYWdlci50aGlzLmNoYW5uZWxzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKICBwdWJsaWMgdm9pZCBjcmVhdGVDaGFubmVsV2l0aE5hbWUoU3RyaW5nIG5hbWUsIGZpbmFsIENvbnN0YW50cy5TdGF0dXNMaXN0ZW5lciBoYW5kbGVyKSB7CiAgICBNYXA8U3RyaW5nLCBPYmplY3Q+IG9wdGlvbnMgPSBuZXcgSGFzaE1hcDw+KCk7CiAgICBvcHRpb25zLnB1dChDb25zdGFudHMuQ0hBTk5FTF9GUklFTkRMWV9OQU1FLCBuYW1lKTsKICAgIG9wdGlvbnMucHV0KENvbnN0YW50cy5DSEFOTkVMX1RZUEUsIENoYW5uZWxUeXBlLkNIQU5ORUxfVFlQRV9QVUJMSUMpOwogICAgdGhpcy5jaGFubmVsc09iamVjdC5jcmVhdGVDaGFubmVsKG9wdGlvbnMsIG5ldyBDb25zdGFudHMuQ3JlYXRlQ2hhbm5lbExpc3RlbmVyKCkgewogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgb25DcmVhdGVkKENoYW5uZWwgY2hhbm5lbCkgewogICAgICAgIGhhbmRsZXIub25TdWNjZXNzKCk7CiAgICAgIH0KCiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBvbkVycm9yKCkgewogICAgICAgIGhhbmRsZXIub25FcnJvcigpOwogICAgICB9CiAgICB9KTsKICB9CgogIHB1YmxpYyB2b2lkIGpvaW5PckNyZWF0ZUdlbmVyYWxDaGFubmVsV2l0aENvbXBsZXRpb24oZmluYWwgQ29uc3RhbnRzLlN0YXR1c0xpc3RlbmVyIGxpc3RlbmVyKSB7CiAgICBpZiAodGhpcy5jaGFubmVscyA9PSBudWxsKSB7CiAgICAgIGxpc3RlbmVyLm9uRXJyb3IoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5nZW5lcmFsQ2hhbm5lbCA9IGNoYW5uZWxzT2JqZWN0LmdldENoYW5uZWxCeVVuaXF1ZU5hbWUoZGVmYXVsdENoYW5uZWxVbmlxdWVOYW1lKTsKICAgIGlmICh0aGlzLmdlbmVyYWxDaGFubmVsICE9IG51bGwpIHsKICAgICAgam9pbkdlbmVyYWxDaGFubmVsV2l0aENvbXBsZXRpb24obGlzdGVuZXIpOwogICAgfSBlbHNlIHsKICAgICAgY3JlYXRlR2VuZXJhbENoYW5uZWxXaXRoQ29tcGxldGlvbihsaXN0ZW5lcik7CiAgICB9CiAgfQoKICBwcml2YXRlIHZvaWQgam9pbkdlbmVyYWxDaGFubmVsV2l0aENvbXBsZXRpb24oZmluYWwgQ29uc3RhbnRzLlN0YXR1c0xpc3RlbmVyIGxpc3RlbmVyKSB7CiAgICBpZiAodGhpcy5nZW5lcmFsQ2hhbm5lbCA9PSBudWxsKSB7CiAgICAgIGxpc3RlbmVyLm9uRXJyb3IoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5nZW5lcmFsQ2hhbm5lbC5qb2luKG5ldyBDb25zdGFudHMuU3RhdHVzTGlzdGVuZXIoKSB7CiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBvblN1Y2Nlc3MoKSB7CiAgICAgICAgbGlzdGVuZXIub25TdWNjZXNzKCk7CiAgICAgIH0KCiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBvbkVycm9yKCkgewogICAgICAgIGxpc3RlbmVyLm9uRXJyb3IoKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBwcml2YXRlIHZvaWQgY3JlYXRlR2VuZXJhbENoYW5uZWxXaXRoQ29tcGxldGlvbihmaW5hbCBDb25zdGFudHMuU3RhdHVzTGlzdGVuZXIgbGlzdGVuZXIpIHsKICAgIE1hcDxTdHJpbmcsIE9iamVjdD4gb3B0aW9ucyA9IG5ldyBIYXNoTWFwPD4oKTsKICAgIG9wdGlvbnMucHV0KENvbnN0YW50cy5DSEFOTkVMX0ZSSUVORExZX05BTUUsIGRlZmF1bHRDaGFubmVsTmFtZSk7CiAgICBvcHRpb25zLnB1dChDb25zdGFudHMuQ0hBTk5FTF9VTklRVUVfTkFNRSwgZGVmYXVsdENoYW5uZWxVbmlxdWVOYW1lKTsKICAgIG9wdGlvbnMucHV0KENvbnN0YW50cy5DSEFOTkVMX1RZUEUsIENoYW5uZWxUeXBlLkNIQU5ORUxfVFlQRV9QVUJMSUMpOwogICAgdGhpcy5jaGFubmVsc09iamVjdC5jcmVhdGVDaGFubmVsKG9wdGlvbnMsIG5ldyBDb25zdGFudHMuQ3JlYXRlQ2hhbm5lbExpc3RlbmVyKCkgewogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgb25DcmVhdGVkKENoYW5uZWwgY2hhbm5lbCkgewogICAgICAgIENoYW5uZWxNYW5hZ2VyLnRoaXMuZ2VuZXJhbENoYW5uZWwgPSBjaGFubmVsOwogICAgICAgIENoYW5uZWxNYW5hZ2VyLnRoaXMuY2hhbm5lbHMuYWRkKGNoYW5uZWwpOwogICAgICAgIGpvaW5HZW5lcmFsQ2hhbm5lbFdpdGhDb21wbGV0aW9uKGxpc3RlbmVyKTsKICAgICAgfQoKICAgICAgQE92ZXJyaWRlCiAgICAgIHB1YmxpYyB2b2lkIG9uRXJyb3IoKSB7CiAgICAgICAgbGlzdGVuZXIub25FcnJvcigpOwogICAgICB9CiAgICB9KTsKICB9CgogIHB1YmxpYyB2b2lkIHNldENoYW5uZWxMaXN0ZW5lcihJUE1lc3NhZ2luZ0NsaWVudExpc3RlbmVyIGxpc3RlbmVyKSB7CiAgICB0aGlzLmxpc3RlbmVyID0gbGlzdGVuZXI7CiAgfQoKICBwcml2YXRlIFN0cmluZyBnZXRTdHJpbmdSZXNvdXJjZShpbnQgaWQpIHsKICAgIFJlc291cmNlcyByZXNvdXJjZXMgPSBUd2lsaW9DaGF0QXBwbGljYXRpb24uZ2V0KCkuZ2V0UmVzb3VyY2VzKCk7CiAgICByZXR1cm4gcmVzb3VyY2VzLmdldFN0cmluZyhpZCk7CiAgfQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbkNoYW5uZWxBZGQoQ2hhbm5lbCBjaGFubmVsKSB7CiAgICBpZiAobGlzdGVuZXIgIT0gbnVsbCkgewogICAgICBsaXN0ZW5lci5vbkNoYW5uZWxBZGQoY2hhbm5lbCk7CiAgICB9CiAgfQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbkNoYW5uZWxDaGFuZ2UoQ2hhbm5lbCBjaGFubmVsKSB7CiAgICBpZiAobGlzdGVuZXIgIT0gbnVsbCkgewogICAgICBsaXN0ZW5lci5vbkNoYW5uZWxDaGFuZ2UoY2hhbm5lbCk7CiAgICB9CiAgfQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbkNoYW5uZWxEZWxldGUoQ2hhbm5lbCBjaGFubmVsKSB7CiAgICBpZiAobGlzdGVuZXIgIT0gbnVsbCkgewogICAgICBsaXN0ZW5lci5vbkNoYW5uZWxEZWxldGUoY2hhbm5lbCk7CiAgICB9CiAgfQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbkVycm9yKGludCBpLCBTdHJpbmcgcykgewogICAgaWYgKGxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgbGlzdGVuZXIub25FcnJvcihpLCBzKTsKICAgIH0KICB9CgogIEBPdmVycmlkZQogIHB1YmxpYyB2b2lkIG9uQXR0cmlidXRlc0NoYW5nZShTdHJpbmcgcykgewogICAgaWYgKGxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgbGlzdGVuZXIub25BdHRyaWJ1dGVzQ2hhbmdlKHMpOwogICAgfQogIH0KCiAgQE92ZXJyaWRlCiAgcHVibGljIHZvaWQgb25DaGFubmVsSGlzdG9yeUxvYWRlZChDaGFubmVsIGNoYW5uZWwpIHsKICAgIGlmIChsaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgIGxpc3RlbmVyLm9uQ2hhbm5lbEhpc3RvcnlMb2FkZWQoY2hhbm5lbCk7CiAgICB9CiAgfQoKICBwcml2YXRlIEhhbmRsZXIgc2V0dXBMaXN0ZW5lckhhbmRsZXIoKSB7CiAgICBMb29wZXIgbG9vcGVyOwogICAgSGFuZGxlciBoYW5kbGVyOwogICAgaWYgKChsb29wZXIgPSBMb29wZXIubXlMb29wZXIoKSkgIT0gbnVsbCkgewogICAgICBoYW5kbGVyID0gbmV3IEhhbmRsZXIobG9vcGVyKTsKICAgIH0gZWxzZSBpZiAoKGxvb3BlciA9IExvb3Blci5nZXRNYWluTG9vcGVyKCkpICE9IG51bGwpIHsKICAgICAgaGFuZGxlciA9IG5ldyBIYW5kbGVyKGxvb3Blcik7CiAgICB9IGVsc2UgewogICAgICBoYW5kbGVyID0gbnVsbDsKICAgICAgdGhyb3cgbmV3IElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbigiQ2hhbm5lbCBMaXN0ZW5lciBtdXN0IGhhdmUgYSBMb29wZXIuIik7CiAgICB9CiAgICByZXR1cm4gaGFuZGxlcjsKICB9Cn0K</textarea>
<textarea class="saurus-file" data-file="app/src/main/java/com/twilio/twiliochat/activities/MainChatActivity.java" data-mode="java">cGFja2FnZSBjb20udHdpbGlvLnR3aWxpb2NoYXQuYWN0aXZpdGllczsKCmltcG9ydCBqYXZhLnV0aWwuTGlzdDsKCmltcG9ydCBhbmRyb2lkLmFwcC5BY3Rpdml0eTsKaW1wb3J0IGFuZHJvaWQuYXBwLlByb2dyZXNzRGlhbG9nOwppbXBvcnQgYW5kcm9pZC5jb250ZW50LkNvbnRleHQ7CmltcG9ydCBhbmRyb2lkLmNvbnRlbnQuRGlhbG9nSW50ZXJmYWNlOwppbXBvcnQgYW5kcm9pZC5jb250ZW50LkludGVudDsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5yZXMuUmVzb3VyY2VzOwppbXBvcnQgYW5kcm9pZC5vcy5CdW5kbGU7CmltcG9ydCBhbmRyb2lkLm9zLkhhbmRsZXI7CmltcG9ydCBhbmRyb2lkLnN1cHBvcnQudjQuYXBwLkZyYWdtZW50VHJhbnNhY3Rpb247CmltcG9ydCBhbmRyb2lkLnN1cHBvcnQudjQudmlldy5HcmF2aXR5Q29tcGF0OwppbXBvcnQgYW5kcm9pZC5zdXBwb3J0LnY0LndpZGdldC5EcmF3ZXJMYXlvdXQ7CmltcG9ydCBhbmRyb2lkLnN1cHBvcnQudjQud2lkZ2V0LlN3aXBlUmVmcmVzaExheW91dDsKaW1wb3J0IGFuZHJvaWQuc3VwcG9ydC52Ny5hcHAuQWN0aW9uQmFyRHJhd2VyVG9nZ2xlOwppbXBvcnQgYW5kcm9pZC5zdXBwb3J0LnY3LmFwcC5BcHBDb21wYXRBY3Rpdml0eTsKaW1wb3J0IGFuZHJvaWQuc3VwcG9ydC52Ny53aWRnZXQuVG9vbGJhcjsKaW1wb3J0IGFuZHJvaWQudmlldy5NZW51OwppbXBvcnQgYW5kcm9pZC52aWV3Lk1lbnVJdGVtOwppbXBvcnQgYW5kcm9pZC52aWV3LlZpZXc7CmltcG9ydCBhbmRyb2lkLndpZGdldC5BZGFwdGVyVmlldzsKaW1wb3J0IGFuZHJvaWQud2lkZ2V0LkJ1dHRvbjsKaW1wb3J0IGFuZHJvaWQud2lkZ2V0Lkxpc3RWaWV3OwppbXBvcnQgYW5kcm9pZC53aWRnZXQuVGV4dFZpZXc7CgppbXBvcnQgY29tLnR3aWxpby5pcG1lc3NhZ2luZy5DaGFubmVsOwppbXBvcnQgY29tLnR3aWxpby5pcG1lc3NhZ2luZy5Db25zdGFudHM7CmltcG9ydCBjb20udHdpbGlvLmlwbWVzc2FnaW5nLklQTWVzc2FnaW5nQ2xpZW50TGlzdGVuZXI7CmltcG9ydCBjb20udHdpbGlvLmlwbWVzc2FnaW5nLlR3aWxpb0lQTWVzc2FnaW5nU0RLOwppbXBvcnQgY29tLnR3aWxpby50d2lsaW9jaGF0LlI7CmltcG9ydCBjb20udHdpbGlvLnR3aWxpb2NoYXQuYXBwbGljYXRpb24uVHdpbGlvQ2hhdEFwcGxpY2F0aW9uOwppbXBvcnQgY29tLnR3aWxpby50d2lsaW9jaGF0LmZyYWdtZW50cy5NYWluQ2hhdEZyYWdtZW50OwppbXBvcnQgY29tLnR3aWxpby50d2lsaW9jaGF0LmludGVyZmFjZXMuSW5wdXRPbkNsaWNrTGlzdGVuZXI7CmltcG9ydCBjb20udHdpbGlvLnR3aWxpb2NoYXQuaW50ZXJmYWNlcy5Mb2FkQ2hhbm5lbExpc3RlbmVyOwppbXBvcnQgY29tLnR3aWxpby50d2lsaW9jaGF0LmludGVyZmFjZXMuTG9naW5MaXN0ZW5lcjsKaW1wb3J0IGNvbS50d2lsaW8udHdpbGlvY2hhdC5pcG1lc3NhZ2luZy5DaGFubmVsQWRhcHRlcjsKaW1wb3J0IGNvbS50d2lsaW8udHdpbGlvY2hhdC5pcG1lc3NhZ2luZy5DaGFubmVsTWFuYWdlcjsKaW1wb3J0IGNvbS50d2lsaW8udHdpbGlvY2hhdC5pcG1lc3NhZ2luZy5JUE1lc3NhZ2luZ0NsaWVudE1hbmFnZXI7CmltcG9ydCBjb20udHdpbGlvLnR3aWxpb2NoYXQudXRpbC5BbGVydERpYWxvZ0hhbmRsZXI7CmltcG9ydCBjb20udHdpbGlvLnR3aWxpb2NoYXQudXRpbC5TZXNzaW9uTWFuYWdlcjsKCnB1YmxpYyBjbGFzcyBNYWluQ2hhdEFjdGl2aXR5IGV4dGVuZHMgQXBwQ29tcGF0QWN0aXZpdHkgaW1wbGVtZW50cyBJUE1lc3NhZ2luZ0NsaWVudExpc3RlbmVyIHsKICBwcml2YXRlIENvbnRleHQgY29udGV4dDsKICBwcml2YXRlIEFjdGl2aXR5IG1haW5BY3Rpdml0eTsKICBwcml2YXRlIEJ1dHRvbiBsb2dvdXRCdXR0b247CiAgcHJpdmF0ZSBCdXR0b24gYWRkQ2hhbm5lbEJ1dHRvbjsKICBwcml2YXRlIFRleHRWaWV3IHVzZXJuYW1lVGV4dFZpZXc7CiAgcHJpdmF0ZSBJUE1lc3NhZ2luZ0NsaWVudE1hbmFnZXIgY2xpZW50OwogIHByaXZhdGUgTGlzdFZpZXcgY2hhbm5lbHNMaXN0VmlldzsKICBwcml2YXRlIENoYW5uZWxBZGFwdGVyIGNoYW5uZWxBZGFwdGVyOwogIHByaXZhdGUgQ2hhbm5lbE1hbmFnZXIgY2hhbm5lbE1hbmFnZXI7CiAgcHJpdmF0ZSBNYWluQ2hhdEZyYWdtZW50IGNoYXRGcmFnbWVudDsKICBwcml2YXRlIERyYXdlckxheW91dCBkcmF3ZXI7CiAgcHJpdmF0ZSBQcm9ncmVzc0RpYWxvZyBwcm9ncmVzc0RpYWxvZzsKICBwcml2YXRlIE1lbnVJdGVtIGxlYXZlQ2hhbm5lbE1lbnVJdGVtOwogIHByaXZhdGUgTWVudUl0ZW0gZGVsZXRlQ2hhbm5lbE1lbnVJdGVtOwogIHByaXZhdGUgU3dpcGVSZWZyZXNoTGF5b3V0IHJlZnJlc2hMYXlvdXQ7CgogIEBPdmVycmlkZQogIHByb3RlY3RlZCB2b2lkIG9uRGVzdHJveSgpIHsKICAgIHN1cGVyLm9uRGVzdHJveSgpOwogICAgbmV3IEhhbmRsZXIoKS5wb3N0KG5ldyBSdW5uYWJsZSgpIHsKICAgICAgQE92ZXJyaWRlCiAgICAgIHB1YmxpYyB2b2lkIHJ1bigpIHsKICAgICAgICBUd2lsaW9DaGF0QXBwbGljYXRpb24uZ2V0KCkuZ2V0SVBNZXNzYWdpbmdDbGllbnQoKS5zZXRJcE1lc3NhZ2luZ0NsaWVudChudWxsKTsKICAgICAgICBUd2lsaW9JUE1lc3NhZ2luZ1NESy5zaHV0ZG93bigpOwogICAgICB9CiAgICB9KTsKICB9CgogIEBPdmVycmlkZQogIHByb3RlY3RlZCB2b2lkIG9uQ3JlYXRlKEJ1bmRsZSBzYXZlZEluc3RhbmNlU3RhdGUpIHsKICAgIHN1cGVyLm9uQ3JlYXRlKHNhdmVkSW5zdGFuY2VTdGF0ZSk7CiAgICBzZXRDb250ZW50VmlldyhSLmxheW91dC5hY3Rpdml0eV9tYWluX2NoYXQpOwogICAgVG9vbGJhciB0b29sYmFyID0gKFRvb2xiYXIpIGZpbmRWaWV3QnlJZChSLmlkLnRvb2xiYXIpOwogICAgc2V0U3VwcG9ydEFjdGlvbkJhcih0b29sYmFyKTsKCiAgICBkcmF3ZXIgPSAoRHJhd2VyTGF5b3V0KSBmaW5kVmlld0J5SWQoUi5pZC5kcmF3ZXJfbGF5b3V0KTsKICAgIEFjdGlvbkJhckRyYXdlclRvZ2dsZSB0b2dnbGUgPSBuZXcgQWN0aW9uQmFyRHJhd2VyVG9nZ2xlKHRoaXMsIGRyYXdlciwgdG9vbGJhciwKICAgICAgICBSLnN0cmluZy5uYXZpZ2F0aW9uX2RyYXdlcl9vcGVuLCBSLnN0cmluZy5uYXZpZ2F0aW9uX2RyYXdlcl9jbG9zZSk7CiAgICBkcmF3ZXIuc2V0RHJhd2VyTGlzdGVuZXIodG9nZ2xlKTsKICAgIHRvZ2dsZS5zeW5jU3RhdGUoKTsKCiAgICByZWZyZXNoTGF5b3V0ID0gKFN3aXBlUmVmcmVzaExheW91dCkgZmluZFZpZXdCeUlkKFIuaWQucmVmcmVzaExheW91dCk7CgogICAgRnJhZ21lbnRUcmFuc2FjdGlvbiBmcmFnbWVudFRyYW5zYWN0aW9uID0gZ2V0U3VwcG9ydEZyYWdtZW50TWFuYWdlcigpLmJlZ2luVHJhbnNhY3Rpb24oKTsKCiAgICBjaGF0RnJhZ21lbnQgPSBuZXcgTWFpbkNoYXRGcmFnbWVudCgpOwogICAgZnJhZ21lbnRUcmFuc2FjdGlvbi5hZGQoUi5pZC5mcmFnbWVudF9jb250YWluZXIsIGNoYXRGcmFnbWVudCk7CiAgICBmcmFnbWVudFRyYW5zYWN0aW9uLmNvbW1pdCgpOwoKICAgIGNvbnRleHQgPSB0aGlzOwogICAgbWFpbkFjdGl2aXR5ID0gdGhpczsKICAgIGxvZ291dEJ1dHRvbiA9IChCdXR0b24pIGZpbmRWaWV3QnlJZChSLmlkLmJ1dHRvbkxvZ291dCk7CiAgICBhZGRDaGFubmVsQnV0dG9uID0gKEJ1dHRvbikgZmluZFZpZXdCeUlkKFIuaWQuYnV0dG9uQWRkQ2hhbm5lbCk7CiAgICB1c2VybmFtZVRleHRWaWV3ID0gKFRleHRWaWV3KSBmaW5kVmlld0J5SWQoUi5pZC50ZXh0Vmlld1VzZXJuYW1lKTsKICAgIGNoYW5uZWxzTGlzdFZpZXcgPSAoTGlzdFZpZXcpIGZpbmRWaWV3QnlJZChSLmlkLmxpc3RWaWV3Q2hhbm5lbHMpOwoKICAgIGNoYW5uZWxNYW5hZ2VyID0gQ2hhbm5lbE1hbmFnZXIuZ2V0SW5zdGFuY2UoKTsKICAgIHNldFVzZXJuYW1lVGV4dFZpZXcoKTsKCiAgICBzZXRVcExpc3RlbmVycygpOwogICAgY2hlY2tUd2lsaW9DbGllbnQoKTsKICB9CgogIHByaXZhdGUgdm9pZCBzZXRVcExpc3RlbmVycygpIHsKICAgIGxvZ291dEJ1dHRvbi5zZXRPbkNsaWNrTGlzdGVuZXIobmV3IFZpZXcuT25DbGlja0xpc3RlbmVyKCkgewogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgb25DbGljayhWaWV3IHYpIHsKICAgICAgICBwcm9tcHRMb2dvdXQoKTsKICAgICAgfQogICAgfSk7CiAgICBhZGRDaGFubmVsQnV0dG9uLnNldE9uQ2xpY2tMaXN0ZW5lcihuZXcgVmlldy5PbkNsaWNrTGlzdGVuZXIoKSB7CiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBvbkNsaWNrKFZpZXcgdikgewogICAgICAgIHNob3dBZGRDaGFubmVsRGlhbG9nKCk7CiAgICAgIH0KICAgIH0pOwogICAgcmVmcmVzaExheW91dC5zZXRPblJlZnJlc2hMaXN0ZW5lcihuZXcgU3dpcGVSZWZyZXNoTGF5b3V0Lk9uUmVmcmVzaExpc3RlbmVyKCkgewogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgb25SZWZyZXNoKCkgewogICAgICAgIHJlZnJlc2hMYXlvdXQuc2V0UmVmcmVzaGluZyh0cnVlKTsKICAgICAgICByZWZyZXNoQ2hhbm5lbHMoKTsKICAgICAgfQogICAgfSk7CiAgICBjaGFubmVsc0xpc3RWaWV3LnNldE9uSXRlbUNsaWNrTGlzdGVuZXIobmV3IEFkYXB0ZXJWaWV3Lk9uSXRlbUNsaWNrTGlzdGVuZXIoKSB7CiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBvbkl0ZW1DbGljayhBZGFwdGVyVmlldzw/PiBwYXJlbnQsIFZpZXcgdmlldywgaW50IHBvc2l0aW9uLCBsb25nIGlkKSB7CiAgICAgICAgc2V0Q2hhbm5lbChwb3NpdGlvbik7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgQE92ZXJyaWRlCiAgcHVibGljIHZvaWQgb25CYWNrUHJlc3NlZCgpIHsKICAgIGlmIChkcmF3ZXIuaXNEcmF3ZXJPcGVuKEdyYXZpdHlDb21wYXQuU1RBUlQpKSB7CiAgICAgIGRyYXdlci5jbG9zZURyYXdlcihHcmF2aXR5Q29tcGF0LlNUQVJUKTsKICAgIH0gZWxzZSB7CiAgICAgIHN1cGVyLm9uQmFja1ByZXNzZWQoKTsKICAgIH0KICB9CgogIEBPdmVycmlkZQogIHB1YmxpYyBib29sZWFuIG9uQ3JlYXRlT3B0aW9uc01lbnUoTWVudSBtZW51KSB7CiAgICBnZXRNZW51SW5mbGF0ZXIoKS5pbmZsYXRlKFIubWVudS5tYWluX2NoYXQsIG1lbnUpOwogICAgdGhpcy5sZWF2ZUNoYW5uZWxNZW51SXRlbSA9IG1lbnUuZmluZEl0ZW0oUi5pZC5hY3Rpb25fbGVhdmVfY2hhbm5lbCk7CiAgICB0aGlzLmxlYXZlQ2hhbm5lbE1lbnVJdGVtLnNldFZpc2libGUoZmFsc2UpOwogICAgdGhpcy5kZWxldGVDaGFubmVsTWVudUl0ZW0gPSBtZW51LmZpbmRJdGVtKFIuaWQuYWN0aW9uX2RlbGV0ZV9jaGFubmVsKTsKICAgIHRoaXMuZGVsZXRlQ2hhbm5lbE1lbnVJdGVtLnNldFZpc2libGUoZmFsc2UpOwogICAgcmV0dXJuIHRydWU7CiAgfQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgYm9vbGVhbiBvbk9wdGlvbnNJdGVtU2VsZWN0ZWQoTWVudUl0ZW0gaXRlbSkgewogICAgaW50IGlkID0gaXRlbS5nZXRJdGVtSWQoKTsKCiAgICBpZiAoaWQgPT0gUi5pZC5hY3Rpb25fbGVhdmVfY2hhbm5lbCkgewogICAgICBsZWF2ZUN1cnJlbnRDaGFubmVsKCk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKGlkID09IFIuaWQuYWN0aW9uX2RlbGV0ZV9jaGFubmVsKSB7CiAgICAgIHByb21wdENoYW5uZWxEZWxldGlvbigpOwogICAgfQoKICAgIHJldHVybiBzdXBlci5vbk9wdGlvbnNJdGVtU2VsZWN0ZWQoaXRlbSk7CiAgfQoKICBwcml2YXRlIFN0cmluZyBnZXRTdHJpbmdSZXNvdXJjZShpbnQgaWQpIHsKICAgIFJlc291cmNlcyByZXNvdXJjZXMgPSBnZXRSZXNvdXJjZXMoKTsKICAgIHJldHVybiByZXNvdXJjZXMuZ2V0U3RyaW5nKGlkKTsKICB9CgogIHByaXZhdGUgdm9pZCByZWZyZXNoQ2hhbm5lbHMoKSB7CiAgICBjaGFubmVsTWFuYWdlci5wb3B1bGF0ZUNoYW5uZWxzKG5ldyBMb2FkQ2hhbm5lbExpc3RlbmVyKCkgewogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgb25DaGFubmVsc0ZpbmlzaGVkTG9hZGluZyhmaW5hbCBMaXN0PENoYW5uZWw+IGNoYW5uZWxzKSB7CiAgICAgICAgcnVuT25VaVRocmVhZChuZXcgUnVubmFibGUoKSB7CiAgICAgICAgICBAT3ZlcnJpZGUKICAgICAgICAgIHB1YmxpYyB2b2lkIHJ1bigpIHsKICAgICAgICAgICAgY2hhbm5lbEFkYXB0ZXIuc2V0Q2hhbm5lbHMoY2hhbm5lbHMpOwogICAgICAgICAgICByZWZyZXNoTGF5b3V0LnNldFJlZnJlc2hpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9CgogIHByaXZhdGUgdm9pZCBwb3B1bGF0ZUNoYW5uZWxzKCkgewogICAgY2hhbm5lbE1hbmFnZXIuc2V0Q2hhbm5lbExpc3RlbmVyKHRoaXMpOwogICAgY2hhbm5lbE1hbmFnZXIucG9wdWxhdGVDaGFubmVscyhuZXcgTG9hZENoYW5uZWxMaXN0ZW5lcigpIHsKICAgICAgQE92ZXJyaWRlCiAgICAgIHB1YmxpYyB2b2lkIG9uQ2hhbm5lbHNGaW5pc2hlZExvYWRpbmcoTGlzdDxDaGFubmVsPiBjaGFubmVscykgewogICAgICAgIGNoYW5uZWxBZGFwdGVyID0gbmV3IENoYW5uZWxBZGFwdGVyKG1haW5BY3Rpdml0eSwgY2hhbm5lbHMpOwogICAgICAgIGNoYW5uZWxzTGlzdFZpZXcuc2V0QWRhcHRlcihjaGFubmVsQWRhcHRlcik7CiAgICAgICAgTWFpbkNoYXRBY3Rpdml0eS50aGlzLmNoYW5uZWxNYW5hZ2VyCiAgICAgICAgICAgIC5qb2luT3JDcmVhdGVHZW5lcmFsQ2hhbm5lbFdpdGhDb21wbGV0aW9uKG5ldyBDb25zdGFudHMuU3RhdHVzTGlzdGVuZXIoKSB7CiAgICAgICAgICBAT3ZlcnJpZGUKICAgICAgICAgIHB1YmxpYyB2b2lkIG9uU3VjY2VzcygpIHsKICAgICAgICAgICAgcnVuT25VaVRocmVhZChuZXcgUnVubmFibGUoKSB7CiAgICAgICAgICAgICAgQE92ZXJyaWRlCiAgICAgICAgICAgICAgcHVibGljIHZvaWQgcnVuKCkgewogICAgICAgICAgICAgICAgY2hhbm5lbEFkYXB0ZXIubm90aWZ5RGF0YVNldENoYW5nZWQoKTsKICAgICAgICAgICAgICAgIHN0b3BBY3Rpdml0eUluZGljYXRvcigpOwogICAgICAgICAgICAgICAgc2V0Q2hhbm5lbCgwKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgcHVibGljIHZvaWQgb25FcnJvcigpIHsKICAgICAgICAgICAgc2hvd0FsZXJ0V2l0aE1lc3NhZ2UoZ2V0U3RyaW5nUmVzb3VyY2UoUi5zdHJpbmcuZ2VuZXJpY19lcnJvcikpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9CgogIHByaXZhdGUgdm9pZCBzZXRDaGFubmVsKGZpbmFsIGludCBwb3NpdGlvbikgewogICAgTGlzdDxDaGFubmVsPiBjaGFubmVscyA9IGNoYW5uZWxNYW5hZ2VyLmdldENoYW5uZWxzKCk7CiAgICBpZiAoY2hhbm5lbHMgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBmaW5hbCBDaGFubmVsIGN1cnJlbnRDaGFubmVsID0gY2hhdEZyYWdtZW50LmdldEN1cnJlbnRDaGFubmVsKCk7CiAgICBmaW5hbCBDaGFubmVsIHNlbGVjdGVkQ2hhbm5lbCA9IGNoYW5uZWxzLmdldChwb3NpdGlvbik7CiAgICBpZiAoY3VycmVudENoYW5uZWwgIT0gbnVsbCAmJiBjdXJyZW50Q2hhbm5lbC5nZXRTaWQoKS5jb250ZW50RXF1YWxzKHNlbGVjdGVkQ2hhbm5lbC5nZXRTaWQoKSkpIHsKICAgICAgZHJhd2VyLmNsb3NlRHJhd2VyKEdyYXZpdHlDb21wYXQuU1RBUlQpOwogICAgICByZXR1cm47CiAgICB9CiAgICBoaWRlTWVudUl0ZW1zKHBvc2l0aW9uKTsKICAgIGlmIChzZWxlY3RlZENoYW5uZWwgIT0gbnVsbCkgewogICAgICBzaG93QWN0aXZpdHlJbmRpY2F0b3IoIkpvaW5pbmcgIiArIHNlbGVjdGVkQ2hhbm5lbC5nZXRGcmllbmRseU5hbWUoKSArICIgY2hhbm5lbCIpOwogICAgICBpZiAoY3VycmVudENoYW5uZWwgIT0gbnVsbCAmJiBjdXJyZW50Q2hhbm5lbC5nZXRTdGF0dXMoKSA9PSBDaGFubmVsLkNoYW5uZWxTdGF0dXMuSk9JTkVEKSB7CiAgICAgICAgdGhpcy5jaGFubmVsTWFuYWdlci5sZWF2ZUNoYW5uZWxXaXRoSGFuZGxlcihjdXJyZW50Q2hhbm5lbCwgbmV3IENvbnN0YW50cy5TdGF0dXNMaXN0ZW5lcigpIHsKICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgcHVibGljIHZvaWQgb25TdWNjZXNzKCkgewogICAgICAgICAgICBqb2luQ2hhbm5lbChzZWxlY3RlZENoYW5uZWwpOwogICAgICAgICAgfQoKICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgcHVibGljIHZvaWQgb25FcnJvcigpIHsKICAgICAgICAgICAgc3RvcEFjdGl2aXR5SW5kaWNhdG9yKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGpvaW5DaGFubmVsKHNlbGVjdGVkQ2hhbm5lbCk7CiAgICAgIHN0b3BBY3Rpdml0eUluZGljYXRvcigpOwogICAgfSBlbHNlIHsKICAgICAgc3RvcEFjdGl2aXR5SW5kaWNhdG9yKCk7CiAgICAgIHNob3dBbGVydFdpdGhNZXNzYWdlKGdldFN0cmluZ1Jlc291cmNlKFIuc3RyaW5nLmdlbmVyaWNfZXJyb3IpKTsKICAgICAgU3lzdGVtLm91dC5wcmludGxuKCJTZWxlY3RlZCBjaGFubmVsIG91dCBvZiByYW5nZSIpOwogICAgfQogIH0KCiAgcHJpdmF0ZSB2b2lkIGpvaW5DaGFubmVsKGZpbmFsIENoYW5uZWwgc2VsZWN0ZWRDaGFubmVsKSB7CiAgICBydW5PblVpVGhyZWFkKG5ldyBSdW5uYWJsZSgpIHsKICAgICAgQE92ZXJyaWRlCiAgICAgIHB1YmxpYyB2b2lkIHJ1bigpIHsKICAgICAgICBjaGF0RnJhZ21lbnQuc2V0Q3VycmVudENoYW5uZWwoc2VsZWN0ZWRDaGFubmVsLCBuZXcgQ29uc3RhbnRzLlN0YXR1c0xpc3RlbmVyKCkgewogICAgICAgICAgQE92ZXJyaWRlCiAgICAgICAgICBwdWJsaWMgdm9pZCBvblN1Y2Nlc3MoKSB7CiAgICAgICAgICAgIE1haW5DaGF0QWN0aXZpdHkudGhpcy5zdG9wQWN0aXZpdHlJbmRpY2F0b3IoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBAT3ZlcnJpZGUKICAgICAgICAgIHB1YmxpYyB2b2lkIG9uRXJyb3IoKSB7fQogICAgICAgIH0pOwogICAgICAgIHNldFRpdGxlKHNlbGVjdGVkQ2hhbm5lbC5nZXRGcmllbmRseU5hbWUoKSk7CiAgICAgICAgZHJhd2VyLmNsb3NlRHJhd2VyKEdyYXZpdHlDb21wYXQuU1RBUlQpOwogICAgICB9CiAgICB9KTsKICB9CgogIHByaXZhdGUgdm9pZCBoaWRlTWVudUl0ZW1zKGZpbmFsIGludCBwb3NpdGlvbikgewogICAgcnVuT25VaVRocmVhZChuZXcgUnVubmFibGUoKSB7CiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBydW4oKSB7CiAgICAgICAgTWFpbkNoYXRBY3Rpdml0eS50aGlzLmxlYXZlQ2hhbm5lbE1lbnVJdGVtLnNldFZpc2libGUocG9zaXRpb24gIT0gMCk7CiAgICAgICAgTWFpbkNoYXRBY3Rpdml0eS50aGlzLmRlbGV0ZUNoYW5uZWxNZW51SXRlbS5zZXRWaXNpYmxlKHBvc2l0aW9uICE9IDApOwogICAgICB9CiAgICB9KTsKICB9CgogIHByaXZhdGUgdm9pZCBzaG93QWRkQ2hhbm5lbERpYWxvZygpIHsKICAgIFN0cmluZyBtZXNzYWdlID0gZ2V0U3RyaW5nUmVzb3VyY2UoUi5zdHJpbmcubmV3X2NoYW5uZWxfcHJvbXB0KTsKICAgIEFsZXJ0RGlhbG9nSGFuZGxlci5kaXNwbGF5SW5wdXREaWFsb2cobWVzc2FnZSwgY29udGV4dCwgbmV3IElucHV0T25DbGlja0xpc3RlbmVyKCkgewogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgb25DbGljayhTdHJpbmcgaW5wdXQpIHsKICAgICAgICBpZiAoaW5wdXQubGVuZ3RoKCkgPT0gMCkgewogICAgICAgICAgc2hvd0FsZXJ0V2l0aE1lc3NhZ2UoZ2V0U3RyaW5nUmVzb3VyY2UoUi5zdHJpbmcuY2hhbm5lbF9uYW1lX3JlcXVpcmVkX21lc3NhZ2UpKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY3JlYXRlQ2hhbm5lbFdpdGhOYW1lKGlucHV0KTsKICAgICAgfQogICAgfSk7CiAgfQoKICBwcml2YXRlIHZvaWQgY3JlYXRlQ2hhbm5lbFdpdGhOYW1lKFN0cmluZyBuYW1lKSB7CiAgICBuYW1lID0gbmFtZS50cmltKCk7CiAgICBpZiAobmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgLmNvbnRlbnRFcXVhbHModGhpcy5jaGFubmVsTWFuYWdlci5nZXREZWZhdWx0Q2hhbm5lbE5hbWUoKS50b0xvd2VyQ2FzZSgpKSkgewogICAgICBzaG93QWxlcnRXaXRoTWVzc2FnZShnZXRTdHJpbmdSZXNvdXJjZShSLnN0cmluZy5jaGFubmVsX25hbWVfZXF1YWxzX2RlZmF1bHRfbmFtZSkpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmNoYW5uZWxNYW5hZ2VyLmNyZWF0ZUNoYW5uZWxXaXRoTmFtZShuYW1lLCBuZXcgQ29uc3RhbnRzLlN0YXR1c0xpc3RlbmVyKCkgewogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgb25TdWNjZXNzKCkgewogICAgICAgIHJlZnJlc2hDaGFubmVscygpOwogICAgICB9CgogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgb25FcnJvcigpIHsKICAgICAgICBzaG93QWxlcnRXaXRoTWVzc2FnZShnZXRTdHJpbmdSZXNvdXJjZShSLnN0cmluZy5nZW5lcmljX2Vycm9yKSk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgcHJpdmF0ZSB2b2lkIHByb21wdENoYW5uZWxEZWxldGlvbigpIHsKICAgIFN0cmluZyBtZXNzYWdlID0gZ2V0U3RyaW5nUmVzb3VyY2UoUi5zdHJpbmcuY2hhbm5lbF9kZWxldGVfcHJvbXB0X21lc3NhZ2UpOwogICAgQWxlcnREaWFsb2dIYW5kbGVyLmRpc3BsYXlDYW5jZWxsYWJsZUFsZXJ0V2l0aEhhbmRsZXIobWVzc2FnZSwgY29udGV4dCwKICAgICAgICBuZXcgRGlhbG9nSW50ZXJmYWNlLk9uQ2xpY2tMaXN0ZW5lcigpIHsKICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgcHVibGljIHZvaWQgb25DbGljayhEaWFsb2dJbnRlcmZhY2UgZGlhbG9nLCBpbnQgd2hpY2gpIHsKICAgICAgICAgICAgZGVsZXRlQ3VycmVudENoYW5uZWwoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICB9CgogIHByaXZhdGUgdm9pZCBkZWxldGVDdXJyZW50Q2hhbm5lbCgpIHsKICAgIENoYW5uZWwgY3VycmVudENoYW5uZWwgPSBjaGF0RnJhZ21lbnQuZ2V0Q3VycmVudENoYW5uZWwoKTsKICAgIGNoYW5uZWxNYW5hZ2VyLmRlbGV0ZUNoYW5uZWxXaXRoSGFuZGxlcihjdXJyZW50Q2hhbm5lbCwgbmV3IENvbnN0YW50cy5TdGF0dXNMaXN0ZW5lcigpIHsKICAgICAgQE92ZXJyaWRlCiAgICAgIHB1YmxpYyB2b2lkIG9uU3VjY2VzcygpIHt9CgogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgb25FcnJvcigpIHsKICAgICAgICBzaG93QWxlcnRXaXRoTWVzc2FnZShnZXRTdHJpbmdSZXNvdXJjZShSLnN0cmluZy5tZXNzYWdlX2RlbGV0aW9uX2ZvcmJpZGRlbikpOwogICAgICB9CiAgICB9KTsKICB9CgogIHByaXZhdGUgdm9pZCBsZWF2ZUN1cnJlbnRDaGFubmVsKCkgewogICAgZmluYWwgQ2hhbm5lbCBjdXJyZW50Q2hhbm5lbCA9IGNoYXRGcmFnbWVudC5nZXRDdXJyZW50Q2hhbm5lbCgpOwogICAgaWYgKGN1cnJlbnRDaGFubmVsLmdldFN0YXR1cygpID09IENoYW5uZWwuQ2hhbm5lbFN0YXR1cy5OT1RfUEFSVElDSVBBVElORykgewogICAgICBzZXRDaGFubmVsKDApOwogICAgICByZXR1cm47CiAgICB9CiAgICBjaGFubmVsTWFuYWdlci5sZWF2ZUNoYW5uZWxXaXRoSGFuZGxlcihjdXJyZW50Q2hhbm5lbCwgbmV3IENvbnN0YW50cy5TdGF0dXNMaXN0ZW5lcigpIHsKICAgICAgQE92ZXJyaWRlCiAgICAgIHB1YmxpYyB2b2lkIG9uU3VjY2VzcygpIHsKICAgICAgICBzZXRDaGFubmVsKDApOwogICAgICB9CgogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgb25FcnJvcigpIHsKICAgICAgICBzdG9wQWN0aXZpdHlJbmRpY2F0b3IoKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBwcml2YXRlIHZvaWQgY2hlY2tUd2lsaW9DbGllbnQoKSB7CiAgICBzaG93QWN0aXZpdHlJbmRpY2F0b3IoZ2V0U3RyaW5nUmVzb3VyY2UoUi5zdHJpbmcubG9hZGluZ19jaGFubmVsc19tZXNzYWdlKSk7CiAgICBjbGllbnQgPSBUd2lsaW9DaGF0QXBwbGljYXRpb24uZ2V0KCkuZ2V0SVBNZXNzYWdpbmdDbGllbnQoKTsKICAgIGlmIChjbGllbnQuZ2V0SXBNZXNzYWdpbmdDbGllbnQoKSA9PSBudWxsKSB7CiAgICAgIGluaXRpYWxpemVDbGllbnQoKTsKICAgIH0gZWxzZSB7CiAgICAgIHBvcHVsYXRlQ2hhbm5lbHMoKTsKICAgIH0KICB9CgogIHByaXZhdGUgdm9pZCBpbml0aWFsaXplQ2xpZW50KCkgewogICAgY2xpZW50LmNvbm5lY3RDbGllbnQobmV3IExvZ2luTGlzdGVuZXIoKSB7CiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBvbkxvZ2luRmluaXNoZWQoKSB7CiAgICAgICAgcG9wdWxhdGVDaGFubmVscygpOwogICAgICB9CgogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgb25Mb2dpbkVycm9yKFN0cmluZyBlcnJvck1lc3NhZ2UpIHsKICAgICAgICBzdG9wQWN0aXZpdHlJbmRpY2F0b3IoKTsKICAgICAgICBzaG93QWxlcnRXaXRoTWVzc2FnZSgiQ2xpZW50IGNvbm5lY3Rpb24gZXJyb3IiKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBwcml2YXRlIHZvaWQgcHJvbXB0TG9nb3V0KCkgewogICAgZmluYWwgU3RyaW5nIG1lc3NhZ2UgPSBnZXRTdHJpbmdSZXNvdXJjZShSLnN0cmluZy5sb2dvdXRfcHJvbXB0X21lc3NhZ2UpOwogICAgcnVuT25VaVRocmVhZChuZXcgUnVubmFibGUoKSB7CiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBydW4oKSB7CiAgICAgICAgQWxlcnREaWFsb2dIYW5kbGVyLmRpc3BsYXlDYW5jZWxsYWJsZUFsZXJ0V2l0aEhhbmRsZXIobWVzc2FnZSwgY29udGV4dCwKICAgICAgICAgICAgbmV3IERpYWxvZ0ludGVyZmFjZS5PbkNsaWNrTGlzdGVuZXIoKSB7CiAgICAgICAgICBAT3ZlcnJpZGUKICAgICAgICAgIHB1YmxpYyB2b2lkIG9uQ2xpY2soRGlhbG9nSW50ZXJmYWNlIGRpYWxvZywgaW50IHdoaWNoKSB7CiAgICAgICAgICAgIFNlc3Npb25NYW5hZ2VyLmdldEluc3RhbmNlKCkubG9nb3V0VXNlcigpOwogICAgICAgICAgICBzaG93TG9naW5BY3Rpdml0eSgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKCiAgfQoKICBwcml2YXRlIHZvaWQgc2hvd0xvZ2luQWN0aXZpdHkoKSB7CiAgICBJbnRlbnQgbGF1bmNoSW50ZW50ID0gbmV3IEludGVudCgpOwogICAgbGF1bmNoSW50ZW50LnNldENsYXNzKGdldEFwcGxpY2F0aW9uQ29udGV4dCgpLCBMb2dpbkFjdGl2aXR5LmNsYXNzKTsKICAgIHN0YXJ0QWN0aXZpdHkobGF1bmNoSW50ZW50KTsKICAgIGZpbmlzaCgpOwogIH0KCiAgcHJpdmF0ZSB2b2lkIHNldFVzZXJuYW1lVGV4dFZpZXcoKSB7CiAgICBTdHJpbmcgdXNlcm5hbWUgPQogICAgICAgIFNlc3Npb25NYW5hZ2VyLmdldEluc3RhbmNlKCkuZ2V0VXNlckRldGFpbHMoKS5nZXQoU2Vzc2lvbk1hbmFnZXIuS0VZX1VTRVJOQU1FKTsKICAgIHVzZXJuYW1lVGV4dFZpZXcuc2V0VGV4dCh1c2VybmFtZSk7CiAgfQoKICBwcml2YXRlIHZvaWQgc3RvcEFjdGl2aXR5SW5kaWNhdG9yKCkgewogICAgcnVuT25VaVRocmVhZChuZXcgUnVubmFibGUoKSB7CiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBydW4oKSB7CiAgICAgICAgaWYgKHByb2dyZXNzRGlhbG9nLmlzU2hvd2luZygpKSB7CiAgICAgICAgICBwcm9ncmVzc0RpYWxvZy5kaXNtaXNzKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CgogIHByaXZhdGUgdm9pZCBzaG93QWN0aXZpdHlJbmRpY2F0b3IoZmluYWwgU3RyaW5nIG1lc3NhZ2UpIHsKICAgIHJ1bk9uVWlUaHJlYWQobmV3IFJ1bm5hYmxlKCkgewogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgcnVuKCkgewogICAgICAgIHByb2dyZXNzRGlhbG9nID0gbmV3IFByb2dyZXNzRGlhbG9nKE1haW5DaGF0QWN0aXZpdHkudGhpcy5tYWluQWN0aXZpdHkpOwogICAgICAgIHByb2dyZXNzRGlhbG9nLnNldE1lc3NhZ2UobWVzc2FnZSk7CiAgICAgICAgcHJvZ3Jlc3NEaWFsb2cuc2hvdygpOwogICAgICAgIHByb2dyZXNzRGlhbG9nLnNldENhbmNlbGVkT25Ub3VjaE91dHNpZGUoZmFsc2UpOwogICAgICAgIHByb2dyZXNzRGlhbG9nLnNldENhbmNlbGFibGUoZmFsc2UpOwogICAgICB9CiAgICB9KTsKICB9CgogIHByaXZhdGUgdm9pZCBzaG93QWxlcnRXaXRoTWVzc2FnZShmaW5hbCBTdHJpbmcgbWVzc2FnZSkgewogICAgcnVuT25VaVRocmVhZChuZXcgUnVubmFibGUoKSB7CiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBydW4oKSB7CiAgICAgICAgQWxlcnREaWFsb2dIYW5kbGVyLmRpc3BsYXlBbGVydFdpdGhNZXNzYWdlKG1lc3NhZ2UsIGNvbnRleHQpOwogICAgICB9CiAgICB9KTsKICB9CgogIEBPdmVycmlkZQogIHB1YmxpYyB2b2lkIG9uQ2hhbm5lbEFkZChDaGFubmVsIGNoYW5uZWwpIHsKICAgIFN5c3RlbS5vdXQucHJpbnRsbigiQ2hhbm5lbCBBZGRlZCIpOwogICAgcmVmcmVzaENoYW5uZWxzKCk7CiAgfQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbkNoYW5uZWxEZWxldGUoZmluYWwgQ2hhbm5lbCBjaGFubmVsKSB7CiAgICBTeXN0ZW0ub3V0LnByaW50bG4oIkNoYW5uZWwgRGVsZXRlZCIpOwogICAgQ2hhbm5lbCBjdXJyZW50Q2hhbm5lbCA9IGNoYXRGcmFnbWVudC5nZXRDdXJyZW50Q2hhbm5lbCgpOwogICAgaWYgKGNoYW5uZWwuZ2V0U2lkKCkuY29udGVudEVxdWFscyhjdXJyZW50Q2hhbm5lbC5nZXRTaWQoKSkpIHsKICAgICAgY2hhdEZyYWdtZW50LnNldEN1cnJlbnRDaGFubmVsKG51bGwsIG51bGwpOwogICAgICBzZXRDaGFubmVsKDApOwogICAgfQogICAgcmVmcmVzaENoYW5uZWxzKCk7CiAgfQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbkNoYW5uZWxDaGFuZ2UoQ2hhbm5lbCBjaGFubmVsKSB7fQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbkVycm9yKGludCBpLCBTdHJpbmcgcykge30KCiAgQE92ZXJyaWRlCiAgcHVibGljIHZvaWQgb25BdHRyaWJ1dGVzQ2hhbmdlKFN0cmluZyBzKSB7fQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbkNoYW5uZWxIaXN0b3J5TG9hZGVkKENoYW5uZWwgY2hhbm5lbCkge30KfQo=</textarea>
<textarea class="saurus-file" data-file="app/src/main/java/com/twilio/twiliochat/fragments/MainChatFragment.java" data-mode="java">cGFja2FnZSBjb20udHdpbGlvLnR3aWxpb2NoYXQuZnJhZ21lbnRzOwoKaW1wb3J0IGphdmEudXRpbC5NYXA7CgppbXBvcnQgYW5kcm9pZC5hcHAuQWN0aXZpdHk7CmltcG9ydCBhbmRyb2lkLmNvbnRlbnQuQ29udGV4dDsKaW1wb3J0IGFuZHJvaWQub3MuQnVuZGxlOwppbXBvcnQgYW5kcm9pZC5zdXBwb3J0LnY0LmFwcC5GcmFnbWVudDsKaW1wb3J0IGFuZHJvaWQudmlldy5LZXlFdmVudDsKaW1wb3J0IGFuZHJvaWQudmlldy5MYXlvdXRJbmZsYXRlcjsKaW1wb3J0IGFuZHJvaWQudmlldy5WaWV3OwppbXBvcnQgYW5kcm9pZC52aWV3LlZpZXdHcm91cDsKaW1wb3J0IGFuZHJvaWQud2lkZ2V0LkJ1dHRvbjsKaW1wb3J0IGFuZHJvaWQud2lkZ2V0LkVkaXRUZXh0OwppbXBvcnQgYW5kcm9pZC53aWRnZXQuTGlzdFZpZXc7CmltcG9ydCBhbmRyb2lkLndpZGdldC5UZXh0VmlldzsKCmltcG9ydCBjb20udHdpbGlvLmlwbWVzc2FnaW5nLkNoYW5uZWw7CmltcG9ydCBjb20udHdpbGlvLmlwbWVzc2FnaW5nLkNoYW5uZWxMaXN0ZW5lcjsKaW1wb3J0IGNvbS50d2lsaW8uaXBtZXNzYWdpbmcuQ29uc3RhbnRzOwppbXBvcnQgY29tLnR3aWxpby5pcG1lc3NhZ2luZy5NZW1iZXI7CmltcG9ydCBjb20udHdpbGlvLmlwbWVzc2FnaW5nLk1lc3NhZ2U7CmltcG9ydCBjb20udHdpbGlvLmlwbWVzc2FnaW5nLk1lc3NhZ2VzOwppbXBvcnQgY29tLnR3aWxpby50d2lsaW9jaGF0LlI7CmltcG9ydCBjb20udHdpbGlvLnR3aWxpb2NoYXQubWVzc2FnaW5nLk1lc3NhZ2VBZGFwdGVyOwppbXBvcnQgY29tLnR3aWxpby50d2lsaW9jaGF0Lm1lc3NhZ2luZy5TdGF0dXNNZXNzYWdlOwoKcHVibGljIGNsYXNzIE1haW5DaGF0RnJhZ21lbnQgZXh0ZW5kcyBGcmFnbWVudCBpbXBsZW1lbnRzIENoYW5uZWxMaXN0ZW5lciB7CiAgQ29udGV4dCBjb250ZXh0OwogIEFjdGl2aXR5IG1haW5BY3Rpdml0eTsKICBCdXR0b24gc2VuZEJ1dHRvbjsKICBMaXN0VmlldyBtZXNzYWdlc0xpc3RWaWV3OwogIEVkaXRUZXh0IG1lc3NhZ2VUZXh0RWRpdDsKCiAgTWVzc2FnZUFkYXB0ZXIgbWVzc2FnZUFkYXB0ZXI7CiAgQ2hhbm5lbCBjdXJyZW50Q2hhbm5lbDsKICBNZXNzYWdlcyBtZXNzYWdlczsKICBNZXNzYWdlW10gbWVzc2FnZXNBcnJheTsKCiAgcHVibGljIE1haW5DaGF0RnJhZ21lbnQoKSB7fQoKICBwdWJsaWMgc3RhdGljIE1haW5DaGF0RnJhZ21lbnQgbmV3SW5zdGFuY2UoKSB7CiAgICBNYWluQ2hhdEZyYWdtZW50IGZyYWdtZW50ID0gbmV3IE1haW5DaGF0RnJhZ21lbnQoKTsKICAgIHJldHVybiBmcmFnbWVudDsKICB9CgogIEBPdmVycmlkZQogIHB1YmxpYyB2b2lkIG9uQ3JlYXRlKEJ1bmRsZSBzYXZlZEluc3RhbmNlU3RhdGUpIHsKICAgIHN1cGVyLm9uQ3JlYXRlKHNhdmVkSW5zdGFuY2VTdGF0ZSk7CiAgICBjb250ZXh0ID0gdGhpcy5nZXRBY3Rpdml0eSgpOwogICAgbWFpbkFjdGl2aXR5ID0gdGhpcy5nZXRBY3Rpdml0eSgpOwogIH0KCiAgQE92ZXJyaWRlCiAgcHVibGljIFZpZXcgb25DcmVhdGVWaWV3KExheW91dEluZmxhdGVyIGluZmxhdGVyLCBWaWV3R3JvdXAgY29udGFpbmVyLAogICAgICBCdW5kbGUgc2F2ZWRJbnN0YW5jZVN0YXRlKSB7CiAgICBWaWV3IHZpZXcgPSBpbmZsYXRlci5pbmZsYXRlKFIubGF5b3V0LmZyYWdtZW50X21haW5fY2hhdCwgY29udGFpbmVyLCBmYWxzZSk7CiAgICBzZW5kQnV0dG9uID0gKEJ1dHRvbikgdmlldy5maW5kVmlld0J5SWQoUi5pZC5idXR0b25TZW5kKTsKICAgIG1lc3NhZ2VzTGlzdFZpZXcgPSAoTGlzdFZpZXcpIHZpZXcuZmluZFZpZXdCeUlkKFIuaWQubGlzdFZpZXdNZXNzYWdlcyk7CiAgICBtZXNzYWdlVGV4dEVkaXQgPSAoRWRpdFRleHQpIHZpZXcuZmluZFZpZXdCeUlkKFIuaWQuZWRpdFRleHRNZXNzYWdlKTsKCiAgICBtZXNzYWdlQWRhcHRlciA9IG5ldyBNZXNzYWdlQWRhcHRlcihtYWluQWN0aXZpdHkpOwogICAgbWVzc2FnZXNMaXN0Vmlldy5zZXRBZGFwdGVyKG1lc3NhZ2VBZGFwdGVyKTsKICAgIHNldFVwTGlzdGVuZXJzKCk7CiAgICBzZXRNZXNzYWdlSW5wdXRFbmFibGVkKGZhbHNlKTsKCiAgICByZXR1cm4gdmlldzsKICB9CgogIEBPdmVycmlkZQogIHB1YmxpYyB2b2lkIG9uQXR0YWNoKENvbnRleHQgY29udGV4dCkgewogICAgc3VwZXIub25BdHRhY2goY29udGV4dCk7CiAgfQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbkRldGFjaCgpIHsKICAgIHN1cGVyLm9uRGV0YWNoKCk7CiAgfQoKICBwcml2YXRlIHZvaWQgc2V0VXBMaXN0ZW5lcnMoKSB7CiAgICBzZW5kQnV0dG9uLnNldE9uQ2xpY2tMaXN0ZW5lcihuZXcgVmlldy5PbkNsaWNrTGlzdGVuZXIoKSB7CiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBvbkNsaWNrKFZpZXcgdikgewogICAgICAgIHNlbmRNZXNzYWdlKCk7CiAgICAgIH0KICAgIH0pOwogICAgbWVzc2FnZVRleHRFZGl0LnNldE9uRWRpdG9yQWN0aW9uTGlzdGVuZXIobmV3IFRleHRWaWV3Lk9uRWRpdG9yQWN0aW9uTGlzdGVuZXIoKSB7CiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgYm9vbGVhbiBvbkVkaXRvckFjdGlvbihUZXh0VmlldyB2LCBpbnQgYWN0aW9uSWQsIEtleUV2ZW50IGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9KTsKICB9CgogIHByaXZhdGUgdm9pZCBzZW5kTWVzc2FnZSgpIHsKICAgIFN0cmluZyBtZXNzYWdlVGV4dCA9IGdldFRleHRJbnB1dCgpOwogICAgaWYgKG1lc3NhZ2VUZXh0Lmxlbmd0aCgpID09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgTWVzc2FnZSBuZXdNZXNzYWdlID0gdGhpcy5tZXNzYWdlcy5jcmVhdGVNZXNzYWdlKG1lc3NhZ2VUZXh0KTsKICAgIHRoaXMubWVzc2FnZXMuc2VuZE1lc3NhZ2UobmV3TWVzc2FnZSwgbnVsbCk7CiAgICBjbGVhclRleHRJbnB1dCgpOwogIH0KCiAgcHVibGljIENoYW5uZWwgZ2V0Q3VycmVudENoYW5uZWwoKSB7CiAgICByZXR1cm4gY3VycmVudENoYW5uZWw7CiAgfQoKICBwdWJsaWMgdm9pZCBzZXRDdXJyZW50Q2hhbm5lbChDaGFubmVsIGN1cnJlbnRDaGFubmVsLCBmaW5hbCBDb25zdGFudHMuU3RhdHVzTGlzdGVuZXIgaGFuZGxlcikgewogICAgaWYgKGN1cnJlbnRDaGFubmVsID09IG51bGwpIHsKICAgICAgdGhpcy5jdXJyZW50Q2hhbm5lbCA9IG51bGw7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghY3VycmVudENoYW5uZWwuZXF1YWxzKHRoaXMuY3VycmVudENoYW5uZWwpKSB7CiAgICAgIHNldE1lc3NhZ2VJbnB1dEVuYWJsZWQoZmFsc2UpOwogICAgICB0aGlzLmN1cnJlbnRDaGFubmVsID0gY3VycmVudENoYW5uZWw7CiAgICAgIHRoaXMuY3VycmVudENoYW5uZWwuc2V0TGlzdGVuZXIodGhpcyk7CiAgICAgIGlmICh0aGlzLmN1cnJlbnRDaGFubmVsLmdldFN0YXR1cygpID09IENoYW5uZWwuQ2hhbm5lbFN0YXR1cy5KT0lORUQpIHsKICAgICAgICBsb2FkTWVzc2FnZXMoaGFuZGxlcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5jdXJyZW50Q2hhbm5lbC5qb2luKG5ldyBDb25zdGFudHMuU3RhdHVzTGlzdGVuZXIoKSB7CiAgICAgICAgICBAT3ZlcnJpZGUKICAgICAgICAgIHB1YmxpYyB2b2lkIG9uU3VjY2VzcygpIHsKICAgICAgICAgICAgbG9hZE1lc3NhZ2VzKGhhbmRsZXIpOwogICAgICAgICAgfQoKICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgcHVibGljIHZvaWQgb25FcnJvcigpIHt9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9CgogIHByaXZhdGUgdm9pZCBsb2FkTWVzc2FnZXMoZmluYWwgQ29uc3RhbnRzLlN0YXR1c0xpc3RlbmVyIGhhbmRsZXIpIHsKICAgIHRoaXMubWVzc2FnZXMgPSB0aGlzLmN1cnJlbnRDaGFubmVsLmdldE1lc3NhZ2VzKCk7CiAgICBtZXNzYWdlc0FycmF5ID0gdGhpcy5tZXNzYWdlcy5nZXRNZXNzYWdlcygpOwogICAgbWFpbkFjdGl2aXR5LnJ1bk9uVWlUaHJlYWQobmV3IFJ1bm5hYmxlKCkgewogICAgICBAT3ZlcnJpZGUKICAgICAgcHVibGljIHZvaWQgcnVuKCkgewogICAgICAgIG1lc3NhZ2VBZGFwdGVyLnNldE1lc3NhZ2VzKG1lc3NhZ2VzQXJyYXkpOwogICAgICAgIHNldE1lc3NhZ2VJbnB1dEVuYWJsZWQodHJ1ZSk7CiAgICAgICAgbWVzc2FnZVRleHRFZGl0LnJlcXVlc3RGb2N1cygpOwogICAgICAgIGhhbmRsZXIub25TdWNjZXNzKCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgcHJpdmF0ZSB2b2lkIHNldE1lc3NhZ2VJbnB1dEVuYWJsZWQoZmluYWwgYm9vbGVhbiBlbmFibGVkKSB7CiAgICBtYWluQWN0aXZpdHkucnVuT25VaVRocmVhZChuZXcgUnVubmFibGUoKSB7CiAgICAgIEBPdmVycmlkZQogICAgICBwdWJsaWMgdm9pZCBydW4oKSB7CiAgICAgICAgTWFpbkNoYXRGcmFnbWVudC50aGlzLnNlbmRCdXR0b24uc2V0RW5hYmxlZChlbmFibGVkKTsKICAgICAgICBNYWluQ2hhdEZyYWdtZW50LnRoaXMubWVzc2FnZVRleHRFZGl0LnNldEVuYWJsZWQoZW5hYmxlZCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgcHJpdmF0ZSBTdHJpbmcgZ2V0VGV4dElucHV0KCkgewogICAgcmV0dXJuIG1lc3NhZ2VUZXh0RWRpdC5nZXRUZXh0KCkudG9TdHJpbmcoKTsKICB9CgogIHByaXZhdGUgdm9pZCBjbGVhclRleHRJbnB1dCgpIHsKICAgIG1lc3NhZ2VUZXh0RWRpdC5zZXRUZXh0KCIiKTsKICB9CgogIEBPdmVycmlkZQogIHB1YmxpYyB2b2lkIG9uTWVzc2FnZUFkZChNZXNzYWdlIG1lc3NhZ2UpIHsKICAgIG1lc3NhZ2VBZGFwdGVyLmFkZE1lc3NhZ2UobWVzc2FnZSk7CiAgfQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbk1lbWJlckpvaW4oTWVtYmVyIG1lbWJlcikgewogICAgU3RhdHVzTWVzc2FnZSBzdGF0dXNNZXNzYWdlID0gbmV3IFN0YXR1c01lc3NhZ2UobWVtYmVyLmdldElkZW50aXR5KCksICJ0aW1lc3RhbXAiLCAiam9pbmVkIik7CiAgICB0aGlzLm1lc3NhZ2VBZGFwdGVyLmFkZFN0YXR1c01lc3NhZ2Uoc3RhdHVzTWVzc2FnZSk7CiAgfQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbk1lbWJlckRlbGV0ZShNZW1iZXIgbWVtYmVyKSB7CiAgICBTdGF0dXNNZXNzYWdlIHN0YXR1c01lc3NhZ2UgPSBuZXcgU3RhdHVzTWVzc2FnZShtZW1iZXIuZ2V0SWRlbnRpdHkoKSwgInRpbWVzdGFtcCIsICJsZWZ0Iik7CiAgICB0aGlzLm1lc3NhZ2VBZGFwdGVyLmFkZFN0YXR1c01lc3NhZ2Uoc3RhdHVzTWVzc2FnZSk7CiAgfQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbk1lc3NhZ2VDaGFuZ2UoTWVzc2FnZSBtZXNzYWdlKSB7fQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbk1lc3NhZ2VEZWxldGUoTWVzc2FnZSBtZXNzYWdlKSB7fQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbk1lbWJlckNoYW5nZShNZW1iZXIgbWVtYmVyKSB7fQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvbkF0dHJpYnV0ZXNDaGFuZ2UoTWFwPFN0cmluZywgU3RyaW5nPiBtYXApIHt9CgogIEBPdmVycmlkZQogIHB1YmxpYyB2b2lkIG9uVHlwaW5nU3RhcnRlZChNZW1iZXIgbWVtYmVyKSB7fQoKICBAT3ZlcnJpZGUKICBwdWJsaWMgdm9pZCBvblR5cGluZ0VuZGVkKE1lbWJlciBtZW1iZXIpIHt9CgogIEBPdmVycmlkZQogIHB1YmxpYyB2b2lkIG9uQ2hhbm5lbEhpc3RvcnlMb2FkZWQoQ2hhbm5lbCBjaGFubmVsKSB7fQp9Cg==</textarea>
</div>
</div><div class="saurus-overview"><ul></ul></div></div><div class="saurus-code"><div class="file-path"><span class="crumb-container"></span><i class="fa fa-fw fa-folder"></i></div><div class="saurus-editor"></div></div><div class="saurus-explorer"><div class="saurus-file-list"></div><a href="https://github.com/TwilioDevEd/twiliochat-android" target="_blank" class="explorer-get-code"> <i class="fa fa-lg fa-github-square"> </i>View Code on GitHub</a></div></div></div></div><script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script><script src="ace/ace.js"></script><script src="ace/theme-monokai.js"></script><script src="viewsaurus.js"></script></body></html>